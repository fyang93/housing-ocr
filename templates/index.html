<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿äº†ä¸ªæˆ¿</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ </text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .drop-zone.dragover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: scale(1.02);
        }
        
        .drop-zone {
            transition: all 0.3s ease;
        }

        .image-viewer-container {
            touch-action: none;
            user-select: none;
        }

        .image-viewer-image {
            transition: transform 0.15s ease-out;
            cursor: grab;
        }

        .image-viewer-image:active {
            cursor: grabbing;
        }

        .viewer-toolbar {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
            <nav class="flex justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ </span>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">æˆ¿äº†ä¸ªæˆ¿</h1>
                        <p class="text-sm text-gray-500 hidden sm:block">æ—¥æœ¬æˆ¿äº§æ–‡æ¡£æ™ºèƒ½è§£æ</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="openUploadModal()" class="hidden md:flex px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transition-all font-medium shadow-lg shadow-blue-300 items-center gap-2">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        ä¸Šä¼ æ–‡æ¡£
                    </button>
                    <button onclick="openUploadModal()" class="md:hidden w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transition-all font-medium shadow-lg shadow-blue-300 flex items-center justify-center">
                        <i data-lucide="upload" class="w-6 h-6"></i>
                    </button>

                    <button onclick="openLocationModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="map" class="w-5 h-5 text-gray-500"></i>
                        ä½ç½®ç®¡ç†
                    </button>
                    <button onclick="openStationModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="train" class="w-5 h-5 text-gray-500"></i>
                        è½¦ç«™æ—¶é•¿
                    </button>
                    <button onclick="openModelModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i>
                        æ¨¡å‹ç®¡ç†
                    </button>
                    <button onclick="deleteAllUnfavorited()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        æ¸…ç†
                    </button>

                    <button onclick="toggleMobileMenu()" class="lg:hidden w-12 h-12 rounded-xl bg-white border border-gray-200 hover:bg-gray-50 transition-all shadow-sm flex items-center justify-center">
                        <i data-lucide="menu" id="menuIcon" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </div>
            </nav>

            <div id="mobileMenu" class="hidden lg:hidden mt-4 p-4 bg-white rounded-2xl border border-gray-200 shadow-lg">
                <div class="flex flex-col gap-2">
                    <button onclick="openLocationModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="map" class="w-5 h-5 text-gray-500"></i>
                        ä½ç½®ç®¡ç†
                    </button>
                    <button onclick="openStationModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="train" class="w-5 h-5 text-gray-500"></i>
                        è½¦ç«™æ—¶é•¿
                    </button>
                    <button onclick="openModelModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i>
                        æ¨¡å‹ç®¡ç†
                    </button>
                    <button onclick="deleteAllUnfavorited(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-red-200 text-red-600 hover:bg-red-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        æ¸…ç†
                    </button>
                </div>
            </div>
        </header>

        <div class="mb-6">
            <div class="flex gap-3 mb-3">
                <div class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="æœç´¢æˆ¿äº§åç§°ã€åœ°å€..."
                       class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white shadow-sm">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                </div>
                <button onclick="toggleFilterPanel()" id="filterToggleBtn" class="px-4 py-3 rounded-xl bg-white border border-gray-200 hover:border-blue-300 transition-all shadow-sm flex items-center gap-2">
                    <i data-lucide="filter" class="w-5 h-5 text-gray-500"></i>
                    <span class="text-gray-700 font-medium">ç­›é€‰</span>
                    <span id="activeFilterCount" class="hidden px-2 py-0.5 bg-blue-500 text-white text-xs rounded-full"></span>
                </button>
            </div>

            <div id="filterPanel" class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»·æ ¼èŒƒå›´ (ä¸‡å††)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="priceMin" placeholder="æœ€ä½" min="0"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            <span class="text-gray-400">-</span>
                            <input type="number" id="priceMax" placeholder="æœ€é«˜" min="0"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸“æœ‰é¢ç§¯ (mÂ²)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="areaMin" placeholder="æœ€ä½" min="0" step="1"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            <span class="text-gray-400">-</span>
                            <input type="number" id="areaMax" placeholder="æœ€é«˜" min="0" step="1"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ­¥è¡Œæ—¶é•¿ (åˆ†é’Ÿ)</label>
                        <select id="walkingFilter" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm cursor-pointer">
                            <option value="">ä¸é™</option>
                            <option value="3">3åˆ†é’Ÿä»¥å†…</option>
                            <option value="5">5åˆ†é’Ÿä»¥å†…</option>
                            <option value="10">10åˆ†é’Ÿä»¥å†…</option>
                            <option value="15">15åˆ†é’Ÿä»¥å†…</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¿äº§ç±»å‹</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="ãƒãƒ³ã‚·ãƒ§ãƒ³" class="property-type-filter hidden">
                                <span class="text-sm">ãƒãƒ³ã‚·ãƒ§ãƒ³</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="ä¸€æˆ¸å»ºã¦" class="property-type-filter hidden">
                                <span class="text-sm">ä¸€æˆ¸å»ºã¦</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="åœŸåœ°" class="property-type-filter hidden">
                                <span class="text-sm">åœŸåœ°</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¿é—´å¸ƒå±€</label>
                        <select id="roomFilter" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm cursor-pointer">
                            <option value="">ä¸é™</option>
                            <option value="1R">1R</option>
                            <option value="1K">1K</option>
                            <option value="1DK">1DK</option>
                            <option value="1LDK">1LDK</option>
                            <option value="2K">2K</option>
                            <option value="2DK">2DK</option>
                            <option value="2LDK">2LDK</option>
                            <option value="3K">3K</option>
                            <option value="3DK">3DK</option>
                            <option value="3LDK">3LDK</option>
                            <option value="4K">4K+</option>
                            <option value="4DK">4DK+</option>
                            <option value="4LDK">4LDK+</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å…¶ä»–æ¡ä»¶</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300 has-[:checked]:text-pink-700">
                                <input type="checkbox" id="petFilter" class="hidden">
                                <span class="text-sm">å¯å…»å® ç‰©</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-green-50 has-[:checked]:border-green-300 has-[:checked]:text-green-700">
                                <input type="checkbox" id="favoriteFilter" class="hidden">
                                <span class="text-sm">ä»…æ”¶è—</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-5 pt-4 border-t border-gray-100">
                    <button onclick="resetFilters()" class="text-sm text-gray-500 hover:text-gray-700 transition flex items-center gap-1">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                        é‡ç½®ç­›é€‰
                    </button>
                    <button onclick="applyFilters()" class="px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium shadow-lg shadow-blue-300 transition-all flex items-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        åº”ç”¨ç­›é€‰
                    </button>
                </div>
            </div>

            <div id="activeFilterTags" class="hidden flex flex-wrap gap-2 mb-3"></div>
        </div>

        <div id="resultInfo" class="mb-4 flex justify-between items-center text-sm text-gray-600">
            <span id="resultCount">å…± 0 ä¸ªæˆ¿äº§</span>
            <span id="filteredCount" class="hidden text-gray-500"></span>
        </div>

        <div id="documentsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </div>

    <div id="uploadModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">ä¸Šä¼ æ–‡æ¡£</h2>
                    <button onclick="closeUploadModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition bg-gray-50 hover:bg-gray-100">
                        <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" class="hidden">
                        <div class="text-gray-500">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-blue-100 flex items-center justify-center">
                                <i data-lucide="cloud-upload" class="w-8 h-8 text-blue-500"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-700">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                            <p class="text-sm text-gray-500 mt-1">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                            <p class="text-xs text-gray-400 mt-3">æ”¯æŒ PDFã€PNGã€JPG æ ¼å¼</p>
                        </div>
                    </div>

                    <div id="fileList" class="mt-4 space-y-2"></div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="uploadFiles()" id="uploadBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-blue-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            å¼€å§‹ä¸Šä¼ 
                        </button>
                        <button onclick="closeUploadModal()" class="px-6 py-3 rounded-xl border border-gray-200 hover:bg-gray-50 transition font-medium">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-900 mb-4">æ–‡æ¡£é¢„è§ˆ</h3>
                        <div id="previewContainer" class="border border-gray-200 rounded-xl bg-gray-50 min-h-[500px] flex items-center justify-center overflow-hidden cursor-pointer hover:border-blue-300 transition-colors" onclick="openImageViewer()" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                OCRæ–‡æœ¬
                            </h4>
                            <div id="ocrTextContainer" class="border border-gray-200 rounded-xl bg-gray-50 p-3 max-h-[300px] overflow-y-auto text-sm text-gray-600 font-mono whitespace-pre-wrap"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <i data-lucide="home" class="w-4 h-4"></i>
                                æˆ¿äº§ä¿¡æ¯
                            </h4>
                            <form id="propertiesForm" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                            </form>
                        </div>
                    </div>

                    <div class="flex justify-center gap-3 pt-4 border-t border-gray-100">
                        <button onclick="retryOCR()" class="px-5 py-2.5 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-medium shadow-md shadow-amber-300 transition-all flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            é‡è¯•OCR
                        </button>
                        <button onclick="retryLLM()" class="px-5 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            é‡è¯•LLM
                        </button>
                        <button onclick="saveProperties()" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium shadow-lg shadow-green-300 transition-all flex items-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            ä¿å­˜ä¿®æ”¹
                        </button>
                        <button onclick="deleteDocument()" class="px-5 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-medium shadow-lg shadow-red-300 transition-all flex items-center gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            åˆ é™¤æ–‡æ¡£
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modelModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">æ¨¡å‹ç®¡ç†</h2>
                    <button onclick="closeModelModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ·»åŠ æ–°æ¨¡å‹</label>
                        <div class="flex gap-2">
                            <input type="text" id="newModelInput" placeholder="ä¾‹å¦‚: google/gemini-2.0-flash-exp:free"
                                   class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <button onclick="addModel()" class="px-5 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all">
                                æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯ç”¨æ¨¡å‹</label>
                        <div id="modelsList" class="space-y-2 max-h-64 overflow-y-auto pr-1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 hidden z-[60] overflow-hidden">
        <div class="h-full w-full flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center px-4 py-3 bg-black/50 border-b border-white/10">
                <h3 id="viewerTitle" class="text-white font-medium truncate"></h3>
                <button onclick="closeImageViewer()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-white transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 relative overflow-hidden image-viewer-container" id="imageViewerContainer">
                <img id="viewerImage" class="image-viewer-image absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 max-w-none" alt="æ–‡æ¡£é¢„è§ˆ">
                <div id="viewerLoading" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-white text-center">
                        <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-3"></div>
                        <p class="text-sm">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="viewer-toolbar flex-shrink-0 flex justify-center items-center gap-2 px-4 py-3">
                <button onclick="zoomOut()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ç¼©å°">
                    <i data-lucide="minus" class="w-5 h-5"></i>
                </button>
                <button onclick="resetZoom()" class="px-4 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition font-medium" id="zoomLevel" title="é‡ç½®ç¼©æ”¾">
                    100%
                </button>
                <button onclick="zoomIn()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="æ”¾å¤§">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
                <div class="w-px h-6 bg-white/30 mx-2"></div>
                <button onclick="fitToScreen()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="é€‚åº”å±å¹•">
                    <i data-lucide="maximize-2" class="w-5 h-5"></i>
                </button>
                <button onclick="actualSize()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="å®é™…å¤§å°">
                    <i data-lucide="scan" class="w-5 h-5"></i>
                </button>
                <div class="w-px h-6 bg-white/30 mx-2"></div>
                <button onclick="rotateLeft()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="å‘å·¦æ—‹è½¬">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
                <button onclick="rotateRight()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="å‘å³æ—‹è½¬">
                    <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="locationModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">ä½ç½®ç®¡ç†</h2>
                    <button onclick="closeLocationModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ·»åŠ æ–°ä½ç½®</label>
                        <div class="flex gap-2">
                            <input type="text" id="newLocationInput" placeholder="ä¾‹å¦‚: æ¸‹è°·, ç¥ä¿ç”º"
                                   class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <button onclick="addLocation()" class="px-5 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all">
                                æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½ç½®åˆ—è¡¨ <span class="text-xs text-gray-400">(å¯æ‹–æ‹½æ’åºï¼Œå‹¾é€‰æ˜¾ç¤ºåœ¨å¡ç‰‡tag)</span></label>
                        <div id="locationsList" class="space-y-2 max-h-64 overflow-y-auto pr-1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stationModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">è½¦ç«™æ—¶é•¿ç®¡ç†</h2>
                    <button onclick="closeStationModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="stationSearchInput" placeholder="æœç´¢è½¦ç«™åç§°..." oninput="filterStations(this.value)"
                                   class="w-full px-4 py-2.5 pl-10 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                    <div id="stationDurationTable" class="overflow-hidden rounded-xl border border-gray-200">
                        <div class="overflow-x-auto">
                            <div class="overflow-y-auto max-h-[400px]">
                                <table class="w-full border-collapse">
                                    <thead class="sticky top-0 bg-gray-50 z-30">
                                        <tr id="tableHeader">
                                            <th class="sticky left-0 bg-gray-50 z-40 px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[150px]">è½¦ç«™</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="noDataMessage" class="hidden text-center py-12 text-gray-500">
                        <i data-lucide="train" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                        <p>æš‚æ— è½¦ç«™æ•°æ®</p>
                        <p class="text-sm mt-1">è¯·å…ˆä¸Šä¼ æˆ¿äº§æ–‡æ¡£è¿›è¡ŒOCRæå–</p>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="loadStationDurations()" class="px-5 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium transition-all flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            åˆ·æ–°
                        </button>
                        <button onclick="saveStationDurations()" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium shadow-lg shadow-blue-300 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            ä¿å­˜æ‰€æœ‰æ—¶é•¿
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDocId = null;
        let documents = [];
        let selectedFiles = [];
        let locations = [];
        let stationDurationsMap = new Map();
        let allStationRows = [];

        const fieldLabels = {
            property_type: 'æˆ¿äº§ç±»å‹',
            property_name: 'æˆ¿äº§åç§°',
            address: 'åœ°å€',
            prefecture: 'éƒ½é“åºœå¿',
            city: 'åŒºå¸‚ç”ºæ‘',
            land_rights: 'åœŸåœ°æƒåˆ©',
            current_status: 'ç°çŠ¶',
            handover_date: 'äº¤æˆ¿æ—¥æœŸ',
            build_year: 'å»ºæˆå¹´ä»½',
            structure: 'æ„é€ ',
            total_floors: 'æ€»å±‚æ•°',
            floor_number: 'æ‰€åœ¨æ¥¼å±‚',
            room_layout: 'æˆ¿é—´å¸ƒå±€',
            orientation: 'æœå‘',
            price: 'å”®ä»·(ä¸‡å††)',
            management_fee: 'ç®¡ç†è´¹(å††/æœˆ)',
            repair_fee: 'ä¿®ç¼®ç§¯ç«‹é‡‘(å††/æœˆ)',
            exclusive_area: 'ä¸“æœ‰é¢ç§¯(mÂ²)',
            balcony_area: 'é˜³å°é¢ç§¯(mÂ²)',
            parking: 'åœè½¦åœº',
            pet_policy: 'å® ç‰©æ”¿ç­–'
        };

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        let filters = {
            search: '',
            priceMin: null,
            priceMax: null,
            areaMin: null,
            areaMax: null,
            walking: null,
            propertyTypes: [],
            room: null,
            pet: false,
            favorite: false
        };

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.search = e.target.value.toLowerCase();
            applyFilters();
        });

        document.getElementById('priceMin').addEventListener('input', applyFilters);
        document.getElementById('priceMax').addEventListener('input', applyFilters);
        document.getElementById('areaMin').addEventListener('input', applyFilters);
        document.getElementById('areaMax').addEventListener('input', applyFilters);
        document.getElementById('walkingFilter').addEventListener('change', applyFilters);
        document.getElementById('roomFilter').addEventListener('change', applyFilters);
        document.getElementById('petFilter').addEventListener('change', applyFilters);
        document.getElementById('favoriteFilter').addEventListener('change', applyFilters);
        document.querySelectorAll('.property-type-filter').forEach(cb => {
            cb.addEventListener('change', applyFilters);
        });

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('hidden');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.getElementById('menuIcon');
            menu.classList.toggle('hidden');
            if (menu.classList.contains('hidden')) {
                icon.setAttribute('data-lucide', 'menu');
            } else {
                icon.setAttribute('data-lucide', 'x');
            }
            lucide.createIcons();
        }

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function handleFileSelect(e) {
            handleFiles(e.target.files);
            fileInput.value = '';
        }

        function handleFiles(files) {
            for (const file of files) {
                if (!selectedFiles.some(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            }
            renderFileList();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group';
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                fileList.appendChild(div);
            });
            uploadBtn.disabled = selectedFiles.length === 0;
            lucide.createIcons();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function openUploadModal() {
            selectedFiles = [];
            renderFileList();
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            selectedFiles = [];
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';

            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.duplicate) {
                        console.log('æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡:', file.name);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', file.name, error.message);
                }
            }

            selectedFiles = [];
            closeUploadModal();
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            loadDocuments();
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const data = await response.json();
                documents = data.documents;
                renderDocuments();
                checkAndRetryFailed();
            } catch (error) {
                console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
            }
        }

        function getDocStatus(doc) {
            const props = doc.properties || {};
            const hasValidProperties = props.address && props.address.trim() !== '' && props.price && props.price !== null && props.price !== '';
            const hasOcrText = doc.ocr_text && doc.ocr_text.trim().length > 0;
            
            if (doc.llm_status === 'done' && doc.ocr_status === 'done' && hasValidProperties) {
                return { priority: 2, status: 'å®Œæˆ', statusClass: 'bg-emerald-500' };
            } else if (doc.llm_status === 'processing' || doc.ocr_status === 'processing') {
                return { priority: 3, status: 'å¤„ç†ä¸­', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'done' && hasOcrText && doc.llm_status === 'pending') {
                return { priority: 3, status: 'å¤„ç†ä¸­', statusClass: 'bg-blue-500' };
            } else if (doc.ocr_status === 'done' && !hasOcrText) {
                return { priority: 3, status: 'å¤„ç†ä¸­', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'pending') {
                return { priority: 3, status: 'å¤„ç†ä¸­', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'failed' || doc.llm_status === 'failed') {
                return { priority: 4, status: 'æå–å¤±è´¥', statusClass: 'bg-red-500' };
            } else {
                return { priority: 3, status: 'å¤„ç†ä¸­', statusClass: 'bg-amber-500' };
            }
        }

        function checkAndRetryFailed() {
            for (const doc of documents) {
                const status = getDocStatus(doc);
                const isFailed = status.status === 'æå–å¤±è´¥';
                const isProcessing = doc.ocr_status === 'processing' || doc.llm_status === 'processing';

                if (isFailed && !isProcessing) {
                    if (doc.ocr_status === 'failed') {
                        fetch(`/api/documents/${doc.id}/retry_ocr`, { method: 'POST' }).catch(() => {});
                    } else if (doc.llm_status === 'failed') {
                        fetch(`/api/documents/${doc.id}/retry_llm`, { method: 'POST' }).catch(() => {});
                    }
                }
            }
        }

        function getActiveFilterCount() {
            let count = 0;
            if (filters.search) count++;
            if (filters.priceMin || filters.priceMax) count++;
            if (filters.areaMin || filters.areaMax) count++;
            if (filters.walking) count++;
            if (filters.propertyTypes.length > 0) count++;
            if (filters.room) count++;
            if (filters.pet) count++;
            if (filters.favorite) count++;
            return count;
        }

        function updateFilterUI() {
            const count = getActiveFilterCount();
            const badge = document.getElementById('activeFilterCount');

            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const tagsContainer = document.getElementById('activeFilterTags');
            if (count > 0) {
                tagsContainer.classList.remove('hidden');
                tagsContainer.innerHTML = '';

                if (filters.search) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700 gap-1"><i data-lucide="search" class="w-3 h-3"></i>${filters.search}<button onclick="removeFilter('search')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.priceMin || filters.priceMax) {
                    const priceText = `${filters.priceMin || '0'} - ${filters.priceMax || 'âˆ'}ä¸‡å††`;
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-amber-50 rounded-full text-xs text-amber-700 gap-1"><i data-lucide="yen" class="w-3 h-3"></i>${priceText}<button onclick="removeFilter('price')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.areaMin || filters.areaMax) {
                    const areaText = `${filters.areaMin || '0'} - ${filters.areaMax || 'âˆ'}mÂ²`;
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-blue-50 rounded-full text-xs text-blue-700 gap-1"><i data-lucide="maximize" class="w-3 h-3"></i>${areaText}<button onclick="removeFilter('area')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.walking) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-teal-50 rounded-full text-xs text-teal-700 gap-1"><i data-lucide="footprints" class="w-3 h-3"></i>${filters.walking}åˆ†ä»¥å†…<button onclick="removeFilter('walking')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.propertyTypes.length > 0) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-purple-50 rounded-full text-xs text-purple-700 gap-1"><i data-lucide="home" class="w-3 h-3"></i>${filters.propertyTypes.join(', ')}<button onclick="removeFilter('propertyTypes')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.room) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700 gap-1"><i data-lucide="layout" class="w-3 h-3"></i>${filters.room}<button onclick="removeFilter('room')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.pet) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-pink-50 rounded-full text-xs text-pink-700 gap-1"><i data-lucide="heart" class="w-3 h-3"></i>å¯å…»å® <button onclick="removeFilter('pet')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.favorite) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-rose-50 rounded-full text-xs text-rose-700 gap-1"><i data-lucide="heart" class="w-3 h-3"></i>ä»…æ”¶è—<button onclick="removeFilter('favorite')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }

                lucide.createIcons();
            } else {
                tagsContainer.classList.add('hidden');
            }
        }

        function removeFilter(filterName) {
            switch (filterName) {
                case 'search':
                    filters.search = '';
                    document.getElementById('searchInput').value = '';
                    break;
                case 'price':
                    filters.priceMin = null;
                    filters.priceMax = null;
                    document.getElementById('priceMin').value = '';
                    document.getElementById('priceMax').value = '';
                    break;
                case 'area':
                    filters.areaMin = null;
                    filters.areaMax = null;
                    document.getElementById('areaMin').value = '';
                    document.getElementById('areaMax').value = '';
                    break;
                case 'walking':
                    filters.walking = null;
                    document.getElementById('walkingFilter').value = '';
                    break;
                case 'propertyTypes':
                    filters.propertyTypes = [];
                    document.querySelectorAll('.property-type-filter').forEach(cb => cb.checked = false);
                    break;
                case 'room':
                    filters.room = null;
                    document.getElementById('roomFilter').value = '';
                    break;
                case 'pet':
                    filters.pet = false;
                    document.getElementById('petFilter').checked = false;
                    break;
                case 'favorite':
                    filters.favorite = false;
                    document.getElementById('favoriteFilter').checked = false;
                    break;
            }
            updateFilterUI();
            applyFilters();
        }

        function resetFilters() {
            filters = {
                search: '',
                priceMin: null,
                priceMax: null,
                areaMin: null,
                areaMax: null,
                walking: null,
                propertyTypes: [],
                room: null,
                pet: false,
                favorite: false
            };

            document.getElementById('searchInput').value = '';
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.getElementById('areaMin').value = '';
            document.getElementById('areaMax').value = '';
            document.getElementById('walkingFilter').value = '';
            document.getElementById('roomFilter').value = '';
            document.querySelectorAll('.property-type-filter').forEach(cb => cb.checked = false);
            document.getElementById('petFilter').checked = false;
            document.getElementById('favoriteFilter').checked = false;

            updateFilterUI();
            applyFilters();
        }

        function applyFilters() {
            filters.priceMin = document.getElementById('priceMin').value ? parseInt(document.getElementById('priceMin').value) : null;
            filters.priceMax = document.getElementById('priceMax').value ? parseInt(document.getElementById('priceMax').value) : null;
            filters.areaMin = document.getElementById('areaMin').value ? parseFloat(document.getElementById('areaMin').value) : null;
            filters.areaMax = document.getElementById('areaMax').value ? parseFloat(document.getElementById('areaMax').value) : null;
            filters.walking = document.getElementById('walkingFilter').value ? parseInt(document.getElementById('walkingFilter').value) : null;
            filters.room = document.getElementById('roomFilter').value || null;
            filters.pet = document.getElementById('petFilter').checked;
            filters.favorite = document.getElementById('favoriteFilter').checked;

            filters.propertyTypes = [];
            document.querySelectorAll('.property-type-filter:checked').forEach(cb => {
                filters.propertyTypes.push(cb.value);
            });

            updateFilterUI();
            renderDocuments();
        }

        function renderDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';

            const filtered = documents.filter(doc => {
                const props = doc.properties || {};

                const matchSearch = !filters.search ||
                    (props.property_name || '').toLowerCase().includes(filters.search) ||
                    (props.address || '').toLowerCase().includes(filters.search);

                const matchPrice = (!filters.priceMin || !props.price || props.price >= filters.priceMin) &&
                    (!filters.priceMax || !props.price || props.price <= filters.priceMax);

                const matchArea = (!filters.areaMin || !props.exclusive_area || parseFloat(props.exclusive_area) >= filters.areaMin) &&
                    (!filters.areaMax || !props.exclusive_area || parseFloat(props.exclusive_area) <= filters.areaMax);

                const matchWalking = !filters.walking || !props.walking_minutes || parseInt(props.walking_minutes) <= filters.walking;

                const matchType = filters.propertyTypes.length === 0 ||
                    (props.property_type && filters.propertyTypes.includes(props.property_type));

                const matchRoom = !filters.room || !props.room_layout || props.room_layout === filters.room;

                const matchPet = !filters.pet || (props.pet_policy && props.pet_policy.includes('å¯'));

                const matchFavorite = !filters.favorite || doc.favorite === 1;

                return matchSearch && matchPrice && matchArea && matchWalking && matchType && matchRoom && matchPet && matchFavorite;
            });

            const sorted = filtered.sort((a, b) => {
                if (b.favorite !== a.favorite) return b.favorite - a.favorite;
                const statusA = getDocStatus(a);
                const statusB = getDocStatus(b);
                return statusA.priority - statusB.priority;
            });

            sorted.forEach(doc => {
                const props = doc.properties || {};
                const status = getDocStatus(doc);
                const hasAddress = props.address && props.address.trim() !== '';
                const hasPrice = props.price && props.price !== null && props.price !== '';
                
                const addressHtml = hasAddress
                    ? `<span class="text-gray-600">${props.address}</span>`
                    : '<div class="animate-pulse bg-gray-200 rounded h-3 w-full"></div>';
                
                const priceHtml = hasPrice
                    ? `<span class="font-bold text-gray-900">${props.price}</span><span class="text-gray-500 text-sm ml-1">ä¸‡å††</span>`
                    : '<div class="animate-pulse bg-gray-200 rounded h-6 w-28"></div>';

                const stationDurations = doc.station_durations || [];
                const locationMap = new Map();
                stationDurations.forEach(sd => {
                    if (sd.show_in_tag === 1) {
                        const key = sd.location_name;
                        if (!locationMap.has(key) || sd.duration < locationMap.get(key).duration) {
                            locationMap.set(key, sd);
                        }
                    }
                });
                const locationTags = Array.from(locationMap.values())
                    .map(sd => `<span class="inline-flex items-center px-2 py-0.5 bg-purple-50 rounded text-xs text-purple-600">${sd.location_name} ${sd.duration}åˆ†</span>`)
                    .join('');

                const card = document.createElement('div');
                card.className = `group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer relative overflow-hidden border border-gray-100 hover:border-blue-300 h-full flex flex-col ${doc.favorite === 1 ? 'ring-2 ring-rose-400' : ''}`;
                card.onclick = (e) => {
                    if (!e.target.closest('.action-btn')) {
                        openModal(doc);
                    }
                };

                const isFavorite = doc.favorite === 1;

                card.innerHTML = `
                    <div class="p-5 pb-3 flex flex-col h-full relative">
                        <div class="absolute top-3 right-3 flex gap-1.5 z-10">
                            <button onclick="toggleFavorite(event, ${doc.id}, ${isFavorite})" class="action-btn w-8 h-8 rounded-full flex items-center justify-center transition-all ${isFavorite ? 'bg-rose-500 text-white shadow-md shadow-rose-300' : 'bg-white/80 text-gray-400 hover:bg-white hover:text-rose-500 backdrop-blur-sm'}">
                                <i data-lucide="${isFavorite ? 'heart' : 'heart'}" class="w-4 h-4 ${isFavorite ? 'fill-white' : ''}"></i>
                            </button>
                            <button onclick="deleteCard(event, ${doc.id})" class="action-btn w-8 h-8 rounded-full flex items-center justify-center bg-white/80 text-gray-400 hover:bg-red-500 hover:text-white backdrop-blur-sm transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 mb-3 line-clamp-1 pr-14">${props.property_name || doc.filename}</h3>

                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3 mb-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        ${hasPrice ? `<span class="text-2xl font-bold text-gray-900">${props.price}</span><span class="text-gray-600 ml-1 text-sm">ä¸‡å††</span>` : '<div class="animate-pulse bg-gray-300 rounded h-8 w-28"></div>'}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${props.exclusive_area ? `<span class="text-sm font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded-lg">${props.exclusive_area}mÂ²${props.balcony_area ? `(+${props.balcony_area}mÂ²)` : ''}</span>` : ''}
                                        ${props.room_layout ? `<span class="text-sm font-medium text-gray-700 bg-gray-100 px-2 py-1 rounded-lg">${props.room_layout}</span>` : ''}
                                    </div>
                                </div>
                            </div>

                                <div class="space-y-2 mb-3">
                                    <div class="flex items-start gap-2">
                                        <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5"></i>
                                        <p class="text-sm text-gray-600 leading-relaxed">${addressHtml}</p>
                                    </div>
                                    ${(props.stations && Array.isArray(props.stations) && props.stations.length > 0) ? `
                                        <div class="flex items-center gap-2 text-sm">
                                            <i data-lucide="train" class="w-4 h-4 text-emerald-500 flex-shrink-0"></i>
                                            <div class="flex flex-wrap gap-1">
                                                ${props.stations.map(s => `
                                                    <span class="inline-flex items-center px-2 py-0.5 bg-teal-50 rounded text-xs text-teal-600">
                                                        <i data-lucide="footprints" class="w-3 h-3 mr-0.5"></i>
                                                        ${s.name} ${s.walking_minutes}åˆ†
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>

                            <div class="flex flex-wrap gap-1.5">
                                ${props.land_rights ? `<span class="inline-flex items-center px-2 py-0.5 bg-orange-50 rounded text-xs text-orange-600">${props.land_rights}</span>` : ''}
                                ${props.build_year ? `<span class="inline-flex items-center px-2 py-0.5 bg-amber-50 rounded text-xs text-amber-600">${new Date().getFullYear() - props.build_year}å¹´</span>` : ''}
                                ${props.pet_policy && props.pet_policy.includes('å¯') ? `<span class="inline-flex items-center px-2 py-0.5 bg-pink-50 rounded text-xs text-pink-600"><i data-lucide="heart" class="w-3 h-3 mr-0.5"></i>å¯å…»å® </span>` : ''}
                                ${locationTags}
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-3 mt-3 border-t border-gray-100 -mx-5 px-5 pb-0">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium text-white ${status.statusClass}">${status.status}</span>
                                ${doc.extracted_model ? `<span class="text-xs text-gray-400">${doc.extracted_model.split('/').pop().split(':')[0]}</span>` : ''}
                            </div>
                            <span class="text-xs text-gray-400">${new Date(doc.upload_time).toLocaleDateString('zh-CN')}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
            updateFilterUI();

            const totalDocs = documents.length;
            const filteredDocs = filtered.length;
            document.getElementById('resultCount').textContent = `å…± ${totalDocs} ä¸ªæˆ¿äº§`;
            const filteredInfo = document.getElementById('filteredCount');
            if (filteredDocs < totalDocs) {
                filteredInfo.textContent = `æ˜¾ç¤º ${filteredDocs} ä¸ªç»“æœ`;
                filteredInfo.classList.remove('hidden');
            } else {
                filteredInfo.classList.add('hidden');
            }
        }

        async function openModal(doc) {
            currentDocId = doc.id;
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const previewContainer = document.getElementById('previewContainer');
            const ocrTextContainer = document.getElementById('ocrTextContainer');
            const form = document.getElementById('propertiesForm');

            const props = doc.properties || {};
            title.textContent = props.property_name || doc.filename;

            previewContainer.innerHTML = `
                <img src="/api/preview/${doc.id}" alt="æ–‡æ¡£é¢„è§ˆ"
                     class="max-w-full max-h-[380px] object-contain"
                     onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\\'text-gray-500\\'>é¢„è§ˆä¸å¯ç”¨</p>'">
                <div class="absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/5 transition-all rounded-xl">
                    <div class="w-12 h-12 rounded-full bg-white/90 shadow-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="maximize-2" class="w-6 h-6 text-gray-700"></i>
                    </div>
                </div>
            `;
            previewContainer.classList.add('group', 'relative');

            ocrTextContainer.textContent = doc.ocr_text || 'æš‚æ— OCRæ–‡æœ¬';

            const fieldOrder = [
                'address', 'price', 'property_name', 'room_layout', 'exclusive_area',
                'build_year', 'structure', 'floor_number', 'total_floors', 'orientation',
                'management_fee', 'repair_fee', 'balcony_area', 'nearest_station', 'train_line', 'walking_minutes',
                'prefecture', 'city', 'land_rights', 'current_status', 'handover_date',
                'parking', 'pet_policy'
            ];

            form.innerHTML = '';
            
            // Compact grid for top fields
            const topFields = ['address', 'price', 'property_name', 'room_layout', 'exclusive_area', 'build_year', 'structure', 'floor_number', 'total_floors'];
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'grid grid-cols-2 gap-2 mb-3';
            
            for (const key of topFields) {
                if (fieldLabels[key]) {
                    const value = props[key] || '';
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    gridDiv.appendChild(div);
                }
            }
            form.appendChild(gridDiv);
            
            // Secondary fields in compact rows
            const secondaryFields = ['orientation', 'management_fee', 'repair_fee', 'balcony_area'];
            const secondaryDiv = document.createElement('div');
            secondaryDiv.className = 'grid grid-cols-3 gap-2 mb-3';
            
            for (const key of secondaryFields) {
                if (fieldLabels[key]) {
                    const value = props[key] || '';
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    secondaryDiv.appendChild(div);
                }
            }
            form.appendChild(secondaryDiv);
            
            // Other fields in compact grid
            const otherFields = ['prefecture', 'city', 'land_rights', 'current_status', 'handover_date', 'parking', 'pet_policy'];
            const otherDiv = document.createElement('div');
            otherDiv.className = 'grid grid-cols-4 gap-2';
            
            for (const key of otherFields) {
                if (fieldLabels[key]) {
                    const value = props[key] || '';
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    otherDiv.appendChild(div);
                }
            }
            form.appendChild(otherDiv);

            // Stations section
            const stationsLabel = document.createElement('label');
            stationsLabel.className = 'text-xs text-gray-500 mb-1 block';
            stationsLabel.textContent = 'é™„è¿‘è½¦ç«™ (æœ€å¤š3ä¸ª)';
            form.appendChild(stationsLabel);

            const stationsDiv = document.createElement('div');
            stationsDiv.className = 'space-y-2 mb-2';
            stationsDiv.id = 'stationsContainer';

            const stations = props.stations && Array.isArray(props.stations) ? props.stations : [];
            for (let i = 0; i < 3; i++) {
                const station = stations[i] || { name: '', line: '', walking_minutes: '' };
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 items-center';
                row.dataset.index = i;
                row.innerHTML = `
                    <div class="col-span-4">
                        <input type="text" name="station_${i}_name" value="${station.name}" placeholder="è½¦ç«™åç§°"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                    <div class="col-span-4">
                        <input type="text" name="station_${i}_line" value="${station.line}" placeholder="çº¿è·¯"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="station_${i}_walking" value="${station.walking_minutes}" placeholder="å¾’æ­¥(åˆ†é’Ÿ)"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                `;
                stationsDiv.appendChild(row);
            }
            form.appendChild(stationsDiv);

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentDocId = null;
        }

        async function deleteDocument() {
            if (!currentDocId) return;

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—?')) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}`, {
                    method: 'DELETE'
                });
                await response.json();
                closeModal();
                loadDocuments();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function deleteAllUnfavorited() {
            const count = documents.filter(d => d.favorite !== 1).length;
            if (count === 0) {
                alert('æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ–‡æ¡£');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${count} ä¸ªéæ”¶è—æ–‡æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

            try {
                const response = await fetch('/api/documents/cleanup', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    alert(`å·²åˆ é™¤ ${result.deleted_count} ä¸ªæ–‡æ¡£`);
                    loadDocuments();
                } else {
                    alert(result.error || 'æ¸…ç†å¤±è´¥');
                }
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        async function toggleFavorite(event, docId, isFavorite) {
            event.stopPropagation();

            try {
                const response = await fetch(`/api/documents/${docId}/favorite`, {
                    method: 'POST'
                });
                const result = await response.json();
                await loadDocuments();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function deleteCard(event, docId) {
            event.stopPropagation();

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—?')) return;

            try {
                const response = await fetch(`/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                await response.json();
                loadDocuments();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function saveProperties() {
            const form = document.getElementById('propertiesForm');
            const formData = new FormData(form);
            const properties = {};

            for (const [key, value] of formData.entries()) {
                if (key.startsWith('station_')) {
                    continue;
                }
                properties[key] = value || null;
            }

            // Handle stations
            const stations = [];
            for (let i = 0; i < 3; i++) {
                const name = formData.get(`station_${i}_name`);
                const line = formData.get(`station_${i}_line`);
                const walking = formData.get(`station_${i}_walking`);
                if (name && name.trim() !== '') {
                    stations.push({
                        name: name.trim(),
                        line: line ? line.trim() : '',
                        walking_minutes: walking ? walking.trim() : ''
                    });
                }
            }
            properties.stations = stations.length > 0 ? stations : null;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(properties)
                });
                await response.json();
                loadDocuments();
                closeModal();
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function openModelModal() {
            await loadModels();
            document.getElementById('modelModal').classList.remove('hidden');
        }

        function closeModelModal() {
            document.getElementById('modelModal').classList.add('hidden');
        }

        async function loadModels() {
            try {
                const response = await fetch(`/api/models?t=${Date.now()}`);
                const data = await response.json();
                renderModels(data.models);
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
            }
        }

        function renderModels(models) {
            const container = document.getElementById('modelsList');
            if (container._sortableInstance) {
                container._sortableInstance.destroy();
            }
            container.innerHTML = '';

            if (models.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i data-lucide="database" class="w-12 h-12 text-gray-300 mb-3"></i>
                        <p class="text-gray-400">æš‚æ— å¯ç”¨æ¨¡å‹</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            models.forEach(model => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group cursor-move';
                div.dataset.model = model;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move"></i>
                        <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="cpu" class="w-4 h-4 text-blue-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium text-sm font-mono">${model}</span>
                    </div>
                    <button onclick="deleteModel('${model}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all group-hover:scale-105">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            container._sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-blue-50',
                handle: '[data-lucide="grip-vertical"]',
                onEnd: async function(evt) {
                    const newOrder = [];
                    container.querySelectorAll('[data-model]').forEach(item => {
                        newOrder.push(item.dataset.model);
                    });
                    try {
                        await fetch('/api/models/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ models: newOrder })
                        });
                    } catch (error) {
                        console.error('ä¿å­˜æ¨¡å‹é¡ºåºå¤±è´¥:', error);
                        await loadModels();
                    }
                }
            });
        }

        async function addModel() {
            const input = document.getElementById('newModelInput');
            const modelName = input.value.trim();

            if (!modelName) {
                alert('è¯·è¾“å…¥æ¨¡å‹åç§°');
                return;
            }

            try {
                const response = await fetch('/api/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                const result = await response.json();
                if (result.success) {
                    input.value = '';
                    await loadModels();
                } else {
                    alert(result.error || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        async function deleteModel(modelName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${modelName}" å—?`)) return;

            try {
                const response = await fetch('/api/models/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                const result = await response.json();
                if (result.success) {
                    await loadModels();
                } else {
                    alert(result.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        let viewerScale = 1;
        let viewerRotation = 0;
        let viewerTranslateX = 0;
        let viewerTranslateY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let viewerImage = null;
        let viewerContainer = null;

        function openImageViewer() {
            if (!currentDocId) return;

            const modal = document.getElementById('imageViewerModal');
            const image = document.getElementById('viewerImage');
            const title = document.getElementById('viewerTitle');
            const loading = document.getElementById('viewerLoading');

            viewerImage = image;
            viewerContainer = document.getElementById('imageViewerContainer');

            const doc = documents.find(d => d.id === currentDocId);
            title.textContent = doc?.filename || 'æ–‡æ¡£é¢„è§ˆ';

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            image.style.display = 'none';

            image.src = `/api/preview/${currentDocId}`;
            image.onload = () => {
                loading.classList.add('hidden');
                image.style.display = 'block';
                fitToScreen();
            };
            image.onerror = () => {
                loading.classList.add('hidden');
                title.textContent = 'é¢„è§ˆåŠ è½½å¤±è´¥';
            };
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.add('hidden');
            resetViewerState();
        }

        function resetViewerState() {
            viewerScale = 1;
            viewerRotation = 0;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            if (!viewerImage) return;
            viewerImage.style.transform = `
                translate(calc(-50% + ${viewerTranslateX}px), calc(-50% + ${viewerTranslateY}px))
                rotate(${viewerRotation}deg)
                scale(${viewerScale})
            `;
            document.getElementById('zoomLevel').textContent = Math.round(viewerScale * 100) + '%';
        }

        function zoomIn() {
            viewerScale = Math.min(viewerScale * 1.2, 5);
            updateImageTransform();
        }

        function zoomOut() {
            viewerScale = Math.max(viewerScale / 1.2, 0.1);
            updateImageTransform();
        }

        function resetZoom() {
            viewerScale = 1;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function fitToScreen() {
            if (!viewerImage || !viewerContainer) return;
            const containerWidth = viewerContainer.clientWidth - 40;
            const containerHeight = viewerContainer.clientHeight - 40;
            const imgRect = viewerImage.getBoundingClientRect();

            const scaleX = containerWidth / imgRect.width;
            const scaleY = containerHeight / imgRect.height;
            viewerScale = Math.min(scaleX, scaleY, 1);
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function actualSize() {
            viewerScale = 1;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function rotateLeft() {
            viewerRotation = (viewerRotation - 90) % 360;
            updateImageTransform();
        }

        function rotateRight() {
            viewerRotation = (viewerRotation + 90) % 360;
            updateImageTransform();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('imageViewerContainer');
            const image = document.getElementById('viewerImage');

            if (container) {
                container.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        if (e.deltaY < 0) {
                            zoomIn();
                        } else {
                            zoomOut();
                        }
                    }
                });

                container.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        isDragging = true;
                        dragStartX = e.clientX - viewerTranslateX;
                        dragStartY = e.clientY - viewerTranslateY;
                        image?.style.setProperty('cursor', 'grabbing');
                    }
                });
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                viewerTranslateX = e.clientX - dragStartX;
                viewerTranslateY = e.clientY - dragStartY;
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                viewerImage?.style.setProperty('cursor', 'grab');
            }
        });

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('imageViewerModal');
            if (modal.classList.contains('hidden')) return;

            if (e.key === 'Escape') {
                closeImageViewer();
            } else if (e.key === '+' || e.key === '=') {
                zoomIn();
            } else if (e.key === '-' || e.key === '_') {
                zoomOut();
            } else if (e.key === 'r' || e.key === 'R') {
                rotateRight();
            } else if (e.key === 'e' || e.key === 'E') {
                rotateLeft();
            } else if (e.key === '0') {
                fitToScreen();
            } else if (e.key === '1') {
                actualSize();
            }
        });

        async function retryLLM() {
            if (!currentDocId) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/retry_llm`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    closeModal();
                    loadDocuments();
                } else {
                    alert('é‡è¯•å¤±è´¥');
                }
            } catch (error) {
                alert('é‡è¯•å¤±è´¥: ' + error.message);
            }
        }

        async function retryOCR() {
            if (!currentDocId) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/retry_ocr`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    closeModal();
                    loadDocuments();
                } else {
                    alert('é‡è¯•å¤±è´¥');
                }
            } catch (error) {
                alert('é‡è¯•å¤±è´¥: ' + error.message);
            }
        }

        async function openLocationModal() {
            await loadLocations();
            document.getElementById('locationModal').classList.remove('hidden');
        }

        function closeLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const data = await response.json();
                locations = data.locations;
                renderLocations();
            } catch (error) {
                console.error('åŠ è½½ä½ç½®å¤±è´¥:', error);
            }
        }

        function renderLocations() {
            const container = document.getElementById('locationsList');
            if (container._sortableInstance) {
                container._sortableInstance.destroy();
            }
            container.innerHTML = '';

            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i data-lucide="map" class="w-12 h-12 text-gray-300 mb-3"></i>
                        <p class="text-gray-400">æš‚æ— ä½ç½®</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            locations.forEach(loc => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group cursor-move';
                div.dataset.location = loc.id;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move"></i>
                        <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                            <i data-lucide="map-pin" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium text-sm">${loc.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="inline-flex items-center px-3 py-1 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-300">
                            <input type="checkbox" class="location-display-filter hidden" ${loc.show_in_tag ? 'checked' : ''} onchange="updateLocationDisplay(${loc.id}, this.checked)">
                            <span class="text-xs text-gray-600">æ˜¾ç¤ºtag</span>
                        </label>
                        <button onclick="deleteLocation(${loc.id})" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all group-hover:scale-105">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            container._sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-blue-50',
                handle: '[data-lucide="grip-vertical"]',
                onEnd: async function(evt) {
                    const newOrder = [];
                    container.querySelectorAll('[data-location]').forEach(item => {
                        newOrder.push(parseInt(item.dataset.location));
                    });
                    try {
                        await fetch('/api/locations/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ location_ids: newOrder })
                        });
                        await loadLocations();
                    } catch (error) {
                        console.error('ä¿å­˜ä½ç½®é¡ºåºå¤±è´¥:', error);
                    }
                }
            });
        }

        async function addLocation() {
            const input = document.getElementById('newLocationInput');
            const name = input.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥ä½ç½®åç§°');
                return;
            }

            try {
                const response = await fetch('/api/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();
                if (result.success) {
                    input.value = '';
                    await loadLocations();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        async function deleteLocation(locationId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½ç½®å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„è½¦ç«™æ—¶é•¿æ•°æ®ã€‚')) return;

            try {
                const response = await fetch(`/api/locations/${locationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    await loadLocations();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function updateLocationDisplay(locationId, showInTag) {
            try {
                const response = await fetch(`/api/locations/${locationId}/display`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ show_in_tag: showInTag ? 1 : 0 })
                });

                const result = await response.json();
                if (result.success) {
                    await loadLocations();
                    await loadDocuments();
                } else {
                    alert('æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        async function openStationModal() {
            await loadLocations();
            await loadStationDurations();
            document.getElementById('stationModal').classList.remove('hidden');
        }

        function closeStationModal() {
            document.getElementById('stationModal').classList.add('hidden');
        }

        async function loadStationDurations() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const table = document.getElementById('stationDurationTable');
            const searchInput = document.getElementById('stationSearchInput');

            tableBody.innerHTML = '';
            allStationRows = [];
            tableHeader.innerHTML = '<th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[150px] sticky left-0 bg-gray-50 z-20">è½¦ç«™</th>';

            const stationNames = new Set();
            documents.forEach(doc => {
                const props = doc.properties || {};
                if (props.stations && Array.isArray(props.stations)) {
                    props.stations.forEach(s => {
                        if (s.name && s.name.trim()) {
                            stationNames.add(s.name.trim());
                        }
                    });
                }
            });

            const sortedStations = Array.from(stationNames).sort();

            if (sortedStations.length === 0 || locations.length === 0) {
                table.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            locations.forEach(loc => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[120px]';
                th.textContent = loc.name;
                tableHeader.appendChild(th);
            });

            let durationsMap = {};
            try {
                const response = await fetch('/api/station_durations');
                const data = await response.json();
                data.durations.forEach(d => {
                    const key = `${d.station_name}_${d.location_id}`;
                    durationsMap[key] = d.duration;
                });
            } catch (error) {
                console.error('åŠ è½½è½¦ç«™æ—¶é•¿å¤±è´¥:', error);
            }

            sortedStations.forEach(stationName => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.dataset.stationName = stationName.toLowerCase();

                const nameTd = document.createElement('td');
                nameTd.className = 'px-4 py-3 text-sm text-gray-900 border-b border-gray-200 font-medium sticky left-0 bg-white hover:bg-gray-50 z-20';
                nameTd.innerHTML = `<i data-lucide="train" class="w-4 h-4 inline mr-2 text-gray-400"></i>${stationName}`;
                tr.appendChild(nameTd);

                locations.forEach(loc => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 border-b border-gray-200 text-center';
                    const key = `${stationName}_${loc.id}`;
                    const value = durationsMap[key] || '';
                    td.innerHTML = `
                        <input type="number"
                               class="w-24 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm text-center"
                               data-station="${stationName}"
                               data-location-id="${loc.id}"
                               value="${value}"
                               min="0"
                               placeholder="-">
                    `;
                    tr.appendChild(td);
                });

                allStationRows.push(tr);
                tableBody.appendChild(tr);
            });

            lucide.createIcons();

            filterStations(searchInput.value);
        }

        function filterStations(searchTerm) {
            const lowerTerm = searchTerm.toLowerCase();

            allStationRows.forEach(row => {
                const stationName = row.dataset.stationName || '';
                if (stationName.includes(lowerTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function saveStationDurations() {
            const inputs = document.querySelectorAll('#tableBody input[type="number"]');
            const durations = [];

            inputs.forEach(input => {
                const stationName = input.dataset.station;
                const locationId = parseInt(input.dataset.locationId);
                const duration = input.value ? parseInt(input.value) : null;
                durations.push({ station_name: stationName, location_id: locationId, duration });
            });

            try {
                const response = await fetch('/api/station_durations/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ durations })
                });
                const result = await response.json();
                if (result.success) {
                    loadDocuments();
                    closeStationModal();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        loadLocations();
        loadDocuments();
        setInterval(loadDocuments, 5000);
        lucide.createIcons();
    </script>
</body>
</html>
