<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êàø‰∫Ü‰∏™Êàø</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .drop-zone.dragover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: scale(1.02);
        }
        
        .drop-zone {
            transition: all 0.3s ease;
        }

        .image-viewer-container {
            touch-action: none;
            user-select: none;
        }

        .image-viewer-image {
            transition: transform 0.2s ease-out;
            cursor: grab;
        }

        .image-viewer-image:active {
            cursor: grabbing;
        }

        #imageViewerModal {
            animation: viewerFadeIn 0.3s ease-out forwards;
        }

        @keyframes viewerFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        #imageViewerModal.closing {
            animation: viewerFadeOut 0.2s ease-in forwards;
        }

        @keyframes viewerFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        #imageViewerModal .viewer-content {
            animation: contentScaleIn 0.3s ease-out 0.05s forwards;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        @keyframes contentScaleIn {
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .viewer-toolbar {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.7);
        }

        #previewContainer {
            transition: border-color 0.2s ease;
        }

        #previewContainer:hover {
            border-color: rgb(59 130 246 / 0.5);
        }

        #previewContainer:hover::after {
            opacity: 1;
        }

        #previewContainer::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(59, 130, 246, 0.05);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        #previewImage {
            transition: transform 0.2s ease;
        }

        #previewContainer:hover #previewImage {
            transform: scale(1.02);
        }

        .skeleton-shimmer {
            background: linear-gradient(
                90deg,
                #e5e7eb 0%,
                #f3f4f6 25%,
                #e5e7eb 50%,
                #f3f4f6 75%,
                #e5e7eb 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
        }

        .image-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
            <nav class="flex justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üè†</span>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Êàø‰∫Ü‰∏™Êàø</h1>
                        <p class="text-sm text-gray-500 hidden sm:block">Êó•Êú¨Êàø‰∫ßÊñáÊ°£Êô∫ËÉΩËß£Êûê</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="openUploadModal()" class="hidden md:flex px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transition-all font-medium shadow-lg shadow-blue-300 items-center gap-2">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        ‰∏ä‰º†ÊñáÊ°£
                    </button>
                    <button onclick="openUploadModal()" class="md:hidden w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transition-all font-medium shadow-lg shadow-blue-300 flex items-center justify-center">
                        <i data-lucide="upload" class="w-6 h-6"></i>
                    </button>

                    <button onclick="openLocationModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="map" class="w-5 h-5 text-gray-500"></i>
                        ‰ΩçÁΩÆÁÆ°ÁêÜ
                    </button>
                    <button onclick="openStationModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="train" class="w-5 h-5 text-gray-500"></i>
                        ËΩ¶Á´ôÊó∂Èïø
                    </button>
                    <button onclick="openModelModal()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-900 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i>
                        Ê®°ÂûãÁÆ°ÁêÜ
                    </button>
                    <button onclick="deleteAllUnfavorited()" class="hidden lg:flex px-4 py-2.5 rounded-xl bg-white border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-all font-medium shadow-sm items-center gap-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        Ê∏ÖÁêÜ
                    </button>

                    <button onclick="toggleMobileMenu()" class="lg:hidden w-12 h-12 rounded-xl bg-white border border-gray-200 hover:bg-gray-50 transition-all shadow-sm flex items-center justify-center">
                        <i data-lucide="menu" id="menuIcon" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </div>
            </nav>

            <div id="mobileMenu" class="hidden lg:hidden mt-4 p-4 bg-white rounded-2xl border border-gray-200 shadow-lg">
                <div class="flex flex-col gap-2">
                    <button onclick="openLocationModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="map" class="w-5 h-5 text-gray-500"></i>
                        ‰ΩçÁΩÆÁÆ°ÁêÜ
                    </button>
                    <button onclick="openStationModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="train" class="w-5 h-5 text-gray-500"></i>
                        ËΩ¶Á´ôÊó∂Èïø
                    </button>
                    <button onclick="openModelModal(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i>
                        Ê®°ÂûãÁÆ°ÁêÜ
                    </button>
                    <button onclick="deleteAllUnfavorited(); toggleMobileMenu()" class="w-full px-4 py-3 rounded-xl bg-white border border-red-200 text-red-600 hover:bg-red-50 transition-all font-medium flex items-center gap-3">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        Ê∏ÖÁêÜ
                    </button>
                </div>
            </div>
        </header>

        <div class="mb-6">
            <div class="flex gap-3 mb-3">
                <div class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Êàø‰∫ßÂêçÁß∞„ÄÅÂú∞ÂùÄ..."
                       class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white shadow-sm">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                </div>
                <button onclick="toggleFilterPanel()" id="filterToggleBtn" class="px-4 py-3 rounded-xl bg-white border border-gray-200 hover:border-blue-300 transition-all shadow-sm flex items-center gap-2">
                    <i data-lucide="filter" class="w-5 h-5 text-gray-500"></i>
                    <span class="text-gray-700 font-medium">Á≠õÈÄâ</span>
                    <span id="activeFilterCount" class="hidden px-2 py-0.5 bg-blue-500 text-white text-xs rounded-full"></span>
                </button>
            </div>

            <div id="filterPanel" class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ª∑Ê†ºËåÉÂõ¥ (‰∏áÂÜÜ)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="priceMin" placeholder="ÊúÄ‰Ωé" min="0"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            <span class="text-gray-400">-</span>
                            <input type="number" id="priceMax" placeholder="ÊúÄÈ´ò" min="0"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ìÊúâÈù¢ÁßØ (m¬≤)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="areaMin" placeholder="ÊúÄ‰Ωé" min="0" step="1"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            <span class="text-gray-400">-</span>
                            <input type="number" id="areaMax" placeholder="ÊúÄÈ´ò" min="0" step="1"
                                   class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê≠•Ë°åÊó∂Èïø (ÂàÜÈíü)</label>
                        <select id="walkingFilter" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm cursor-pointer">
                            <option value="">‰∏çÈôê</option>
                            <option value="3">3ÂàÜÈíü‰ª•ÂÜÖ</option>
                            <option value="5">5ÂàÜÈíü‰ª•ÂÜÖ</option>
                            <option value="10">10ÂàÜÈíü‰ª•ÂÜÖ</option>
                            <option value="15">15ÂàÜÈíü‰ª•ÂÜÖ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êàø‰∫ßÁ±ªÂûã</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="„Éû„É≥„Ç∑„Éß„É≥" class="property-type-filter hidden">
                                <span class="text-sm">„Éû„É≥„Ç∑„Éß„É≥</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="‰∏ÄÊà∏Âª∫„Å¶" class="property-type-filter hidden">
                                <span class="text-sm">‰∏ÄÊà∏Âª∫„Å¶</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:text-blue-700">
                                <input type="checkbox" value="ÂúüÂú∞" class="property-type-filter hidden">
                                <span class="text-sm">ÂúüÂú∞</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊàøÈó¥Â∏ÉÂ±Ä</label>
                        <select id="roomFilter" class="w-full px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm cursor-pointer">
                            <option value="">‰∏çÈôê</option>
                            <option value="1R">1R</option>
                            <option value="1K">1K</option>
                            <option value="1DK">1DK</option>
                            <option value="1LDK">1LDK</option>
                            <option value="2K">2K</option>
                            <option value="2DK">2DK</option>
                            <option value="2LDK">2LDK</option>
                            <option value="3K">3K</option>
                            <option value="3DK">3DK</option>
                            <option value="3LDK">3LDK</option>
                            <option value="4K">4K+</option>
                            <option value="4DK">4DK+</option>
                            <option value="4LDK">4LDK+</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÖ∂‰ªñÊù°‰ª∂</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300 has-[:checked]:text-pink-700">
                                <input type="checkbox" id="petFilter" class="hidden">
                                <span class="text-sm">ÂèØÂÖªÂÆ†Áâ©</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-green-50 has-[:checked]:border-green-300 has-[:checked]:text-green-700">
                                <input type="checkbox" id="favoriteFilter" class="hidden">
                                <span class="text-sm">‰ªÖÊî∂Ëóè</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-5 pt-4 border-t border-gray-100">
                    <button onclick="resetFilters()" class="text-sm text-gray-500 hover:text-gray-700 transition flex items-center gap-1">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                        ÈáçÁΩÆÁ≠õÈÄâ
                    </button>
                    <button onclick="applyFilters()" class="px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium shadow-lg shadow-blue-300 transition-all flex items-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Â∫îÁî®Á≠õÈÄâ
                    </button>
                </div>
            </div>

            <div id="activeFilterTags" class="hidden flex flex-wrap gap-2 mb-3"></div>
        </div>

        <div id="resultInfo" class="mb-4 flex justify-between items-center text-sm text-gray-600">
            <span id="resultCount">ÂÖ± 0 ‰∏™Êàø‰∫ß</span>
            <span id="filteredCount" class="hidden text-gray-500"></span>
        </div>

        <div id="documentsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </div>

    <div id="uploadModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">‰∏ä‰º†ÊñáÊ°£</h2>
                    <button onclick="closeUploadModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition bg-gray-50 hover:bg-gray-100">
                        <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" class="hidden">
                        <div class="text-gray-500">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-blue-100 flex items-center justify-center">
                                <i data-lucide="cloud-upload" class="w-8 h-8 text-blue-500"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-700">ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</p>
                            <p class="text-sm text-gray-500 mt-1">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</p>
                            <p class="text-xs text-gray-400 mt-3">ÊîØÊåÅ PDF„ÄÅPNG„ÄÅJPG Ê†ºÂºè</p>
                        </div>
                    </div>

                    <div id="fileList" class="mt-4 space-y-2"></div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="uploadFiles()" id="uploadBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-blue-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ÂºÄÂßã‰∏ä‰º†
                        </button>
                        <button onclick="closeUploadModal()" class="px-6 py-3 rounded-xl border border-gray-200 hover:bg-gray-50 transition font-medium">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-900 mb-4">ÊñáÊ°£È¢ÑËßà</h3>
                        <div id="previewContainer" class="border border-gray-200 rounded-xl bg-gray-50 overflow-hidden cursor-pointer relative min-h-[400px]" onclick="openImageViewer(event)" title="ÁÇπÂáªÊü•ÁúãÂ§ßÂõæ">
                            <div id="previewLoading" class="absolute inset-0 bg-gray-50 z-10 p-8 flex flex-col items-center justify-center">
                                <div class="w-full max-w-2xl space-y-4">
                                    <div class="skeleton-shimmer h-4 w-3/4 rounded-md skeleton-pulse"></div>
                                    <div class="skeleton-shimmer h-3 w-1/2 rounded-md skeleton-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="flex gap-4 mt-6">
                                        <div class="flex-1 space-y-3">
                                            <div class="skeleton-shimmer h-2 w-full rounded-md skeleton-pulse" style="animation-delay: 0.3s"></div>
                                            <div class="skeleton-shimmer h-2 w-5/6 rounded-md skeleton-pulse" style="animation-delay: 0.4s"></div>
                                            <div class="skeleton-shimmer h-2 w-4/5 rounded-md skeleton-pulse" style="animation-delay: 0.5s"></div>
                                        </div>
                                        <div class="flex-1 space-y-3">
                                            <div class="skeleton-shimmer h-2 w-full rounded-md skeleton-pulse" style="animation-delay: 0.35s"></div>
                                            <div class="skeleton-shimmer h-2 w-3/4 rounded-md skeleton-pulse" style="animation-delay: 0.45s"></div>
                                            <div class="skeleton-shimmer h-2 w-5/6 rounded-md skeleton-pulse" style="animation-delay: 0.55s"></div>
                                        </div>
                                    </div>
                                    <div class="mt-6 grid grid-cols-2 gap-4">
                                        <div class="skeleton-shimmer h-32 rounded-lg skeleton-pulse" style="animation-delay: 0.6s"></div>
                                        <div class="skeleton-shimmer h-32 rounded-lg skeleton-pulse" style="animation-delay: 0.7s"></div>
                                    </div>
                                    <div class="space-y-2 mt-4">
                                        <div class="skeleton-shimmer h-2 w-full rounded-md skeleton-pulse" style="animation-delay: 0.8s"></div>
                                        <div class="skeleton-shimmer h-2 w-2/3 rounded-md skeleton-pulse" style="animation-delay: 0.9s"></div>
                                    </div>
                                </div>
                            </div>
                            <img id="previewImage" class="w-full h-auto object-contain max-h-[60vh] mx-auto hidden" alt="ÊñáÊ°£È¢ÑËßà" onload="onPreviewLoaded()" onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\\'text-gray-500 p-4\\'>È¢ÑËßà‰∏çÂèØÁî®</p>'">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                OCRÊñáÊú¨
                            </h4>
                            <div id="ocrTextContainer" class="border border-gray-200 rounded-xl bg-gray-50 p-3 max-h-[300px] overflow-y-auto text-sm text-gray-600 font-mono whitespace-pre-wrap"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <i data-lucide="home" class="w-4 h-4"></i>
                                Êàø‰∫ß‰ø°ÊÅØ
                            </h4>
                            <form id="propertiesForm" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                            </form>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-center gap-3 pt-4 border-t border-gray-100">
                        <button onclick="retryOCR()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-medium shadow-md shadow-amber-300 transition-all active:scale-95">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            ÈáçËØïOCR
                        </button>
                        <button onclick="retryLLM()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all active:scale-95">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            ÈáçËØïLLM
                        </button>
                        <button onclick="saveProperties()" class="flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium shadow-lg shadow-green-300 transition-all active:scale-95 md:shadow-md">
                            <i data-lucide="check" class="w-5 h-5 md:w-4 md:h-4"></i>
                            ‰øùÂ≠ò‰øÆÊîπ
                        </button>
                        <button onclick="deleteDocument()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 font-medium transition-all active:scale-95 md:bg-red-500 md:hover:bg-red-600 md:text-white md:shadow-md md:shadow-red-300">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Âà†Èô§ÊñáÊ°£
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modelModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">Ê®°ÂûãÁÆ°ÁêÜ</h2>
                    <button onclick="closeModelModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∑ªÂä†Êñ∞Ê®°Âûã</label>
                        <div class="flex gap-2">
                            <input type="text" id="newModelInput" placeholder="‰æãÂ¶Ç: google/gemini-2.0-flash-exp:free"
                                   class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <button onclick="addModel()" class="px-5 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all">
                                Ê∑ªÂä†
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂèØÁî®Ê®°Âûã</label>
                        <div id="modelsList" class="space-y-2 max-h-64 overflow-y-auto pr-1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 hidden z-[60] overflow-hidden">
        <div class="h-full w-full flex flex-col viewer-content">
            <div class="flex-shrink-0 flex justify-between items-center px-4 py-3 bg-black/50 border-b border-white/10">
                <h3 id="viewerTitle" class="text-white font-medium truncate"></h3>
                <button onclick="closeImageViewer()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-white transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 relative overflow-hidden image-viewer-container" id="imageViewerContainer">
                <img id="viewerImage" class="image-viewer-image" alt="ÊñáÊ°£È¢ÑËßà">
                <div id="viewerLoading" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-white text-center">
                        <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-3"></div>
                        <p class="text-sm">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>
            </div>

            <div class="viewer-toolbar flex-shrink-0 flex justify-center items-center gap-2 px-4 py-3">
                <button onclick="zoomOut()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="Áº©Â∞è">
                    <i data-lucide="minus" class="w-5 h-5"></i>
                </button>
                <button onclick="resetZoom()" class="px-4 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition font-medium" id="zoomLevel" title="ÈáçÁΩÆÁº©Êîæ">
                    100%
                </button>
                <button onclick="zoomIn()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ÊîæÂ§ß">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
                <div class="w-px h-6 bg-white/30 mx-2"></div>
                <button onclick="fitToScreen()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ÈÄÇÂ∫îÂ±èÂπï">
                    <i data-lucide="maximize-2" class="w-5 h-5"></i>
                </button>
                <button onclick="actualSize()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ÂÆûÈôÖÂ§ßÂ∞è">
                    <i data-lucide="scan" class="w-5 h-5"></i>
                </button>
                <div class="w-px h-6 bg-white/30 mx-2"></div>
                <button onclick="rotateLeft()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ÂêëÂ∑¶ÊóãËΩ¨">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
                <button onclick="rotateRight()" class="w-10 h-10 rounded-lg hover:bg-white/10 flex items-center justify-center text-white transition" title="ÂêëÂè≥ÊóãËΩ¨">
                    <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="locationModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">‰ΩçÁΩÆÁÆ°ÁêÜ</h2>
                    <button onclick="closeLocationModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∑ªÂä†Êñ∞‰ΩçÁΩÆ</label>
                        <div class="flex gap-2">
                            <input type="text" id="newLocationInput" placeholder="‰æãÂ¶Ç: Ê∏ãË∞∑, Á•û‰øùÁî∫"
                                   class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <button onclick="addLocation()" class="px-5 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-medium shadow-md shadow-blue-300 transition-all">
                                Ê∑ªÂä†
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ΩçÁΩÆÂàóË°® <span class="text-xs text-gray-400">(ÂèØÊãñÊãΩÊéíÂ∫èÔºåÂãæÈÄâÊòæÁ§∫Âú®Âç°Áâátag)</span></label>
                        <div id="locationsList" class="space-y-2 max-h-64 overflow-y-auto pr-1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stationModal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full border border-gray-100">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">ËΩ¶Á´ôÊó∂ÈïøÁÆ°ÁêÜ</h2>
                    <button onclick="closeStationModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 transition flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="stationSearchInput" placeholder="ÊêúÁ¥¢ËΩ¶Á´ôÂêçÁß∞..." oninput="filterStations(this.value)"
                                   class="w-full px-4 py-2.5 pl-10 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white shadow-sm">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                    <div id="stationDurationTable" class="overflow-hidden rounded-xl border border-gray-200">
                        <div class="overflow-x-auto">
                            <div class="overflow-y-auto max-h-[400px]">
                                <table class="w-full border-collapse">
                                    <thead class="sticky top-0 bg-gray-50 z-30">
                                        <tr id="tableHeader">
                                            <th class="sticky left-0 bg-gray-50 z-40 px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[150px]">ËΩ¶Á´ô</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="noDataMessage" class="hidden text-center py-12 text-gray-500">
                        <i data-lucide="train" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                        <p>ÊöÇÊó†ËΩ¶Á´ôÊï∞ÊçÆ</p>
                        <p class="text-sm mt-1">ËØ∑ÂÖà‰∏ä‰º†Êàø‰∫ßÊñáÊ°£ËøõË°åOCRÊèêÂèñ</p>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="loadStationDurations()" class="px-5 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium transition-all flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Âà∑Êñ∞
                        </button>
                        <button onclick="saveStationDurations()" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium shadow-lg shadow-blue-300 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            ‰øùÂ≠òÊâÄÊúâÊó∂Èïø
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDocId = null;
        let documents = [];
        let selectedFiles = [];
        let locations = [];
        let stationDurationsMap = new Map();
        let allStationRows = [];

        const fieldLabels = {
            property_type: 'Êàø‰∫ßÁ±ªÂûã',
            property_name: 'Êàø‰∫ßÂêçÁß∞',
            address: 'Âú∞ÂùÄ',
            prefecture: 'ÈÉΩÈÅìÂ∫úÂéø',
            city: 'Âå∫Â∏ÇÁî∫Êùë',
            land_rights: 'ÂúüÂú∞ÊùÉÂà©',
            current_status: 'Áé∞Áä∂',
            handover_date: '‰∫§ÊàøÊó•Êúü',
            build_year: 'Âª∫ÊàêÂπ¥‰ªΩ',
            structure: 'ÊûÑÈÄ†',
            total_floors: 'ÊÄªÂ±ÇÊï∞',
            floor_number: 'ÊâÄÂú®Ê•ºÂ±Ç',
            room_layout: 'ÊàøÈó¥Â∏ÉÂ±Ä',
            orientation: 'ÊúùÂêë',
            price: 'ÂîÆ‰ª∑(‰∏áÂÜÜ)',
            management_fee: 'ÁÆ°ÁêÜË¥π(ÂÜÜ/Êúà)',
            repair_fee: '‰øÆÁºÆÁßØÁ´ãÈáë(ÂÜÜ/Êúà)',
            exclusive_area: '‰∏ìÊúâÈù¢ÁßØ(m¬≤)',
            balcony_area: 'Èò≥Âè∞Èù¢ÁßØ(m¬≤)',
            parking: 'ÂÅúËΩ¶Âú∫',
            pet_policy: 'ÂÆ†Áâ©ÊîøÁ≠ñ',
            corner_room: 'ËßíÈÉ®Â±ã'
        };

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        let filters = {
            search: '',
            priceMin: null,
            priceMax: null,
            areaMin: null,
            areaMax: null,
            walking: null,
            propertyTypes: [],
            room: null,
            pet: false,
            favorite: false
        };

        const ITEMS_PER_PAGE = 12;
        let currentPage = 1;
        let filteredDocuments = [];

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.search = e.target.value.toLowerCase();
            applyFilters();
        });

        document.getElementById('priceMin').addEventListener('input', applyFilters);
        document.getElementById('priceMax').addEventListener('input', applyFilters);
        document.getElementById('areaMin').addEventListener('input', applyFilters);
        document.getElementById('areaMax').addEventListener('input', applyFilters);
        document.getElementById('walkingFilter').addEventListener('change', applyFilters);
        document.getElementById('roomFilter').addEventListener('change', applyFilters);
        document.getElementById('petFilter').addEventListener('change', applyFilters);
        document.getElementById('favoriteFilter').addEventListener('change', applyFilters);
        document.querySelectorAll('.property-type-filter').forEach(cb => {
            cb.addEventListener('change', applyFilters);
        });

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('hidden');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.getElementById('menuIcon');
            menu.classList.toggle('hidden');
            if (menu.classList.contains('hidden')) {
                icon.setAttribute('data-lucide', 'menu');
            } else {
                icon.setAttribute('data-lucide', 'x');
            }
            lucide.createIcons();
        }

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function handleFileSelect(e) {
            handleFiles(e.target.files);
            fileInput.value = '';
        }

        function handleFiles(files) {
            for (const file of files) {
                if (!selectedFiles.some(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            }
            renderFileList();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group';
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                fileList.appendChild(div);
            });
            uploadBtn.disabled = selectedFiles.length === 0;
            lucide.createIcons();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function openUploadModal() {
            selectedFiles = [];
            renderFileList();
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            selectedFiles = [];
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‰∏ä‰º†‰∏≠...';

            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.duplicate) {
                        console.log('Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåË∑≥Ëøá:', file.name);
                    }
                } catch (error) {
                    console.error('‰∏ä‰º†Â§±Ë¥•:', file.name, error.message);
                }
            }

            selectedFiles = [];
            closeUploadModal();
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'ÂºÄÂßã‰∏ä‰º†';
            loadDocuments();
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const data = await response.json();
                documents = data.documents;
                renderDocuments();
                checkAndRetryFailed();
            } catch (error) {
                console.error('Âä†ËΩΩÊñáÊ°£Â§±Ë¥•:', error);
            }
        }

        function getDocStatus(doc) {
            const props = doc.properties || {};
            const hasValidProperties = props.address && props.address.trim() !== '' && props.price && props.price !== null && props.price !== '';
            const hasOcrText = doc.ocr_text && doc.ocr_text.trim().length > 0;
            
            if (doc.llm_status === 'done' && doc.ocr_status === 'done' && hasValidProperties) {
                return { priority: 2, status: 'ÂÆåÊàê', statusClass: 'bg-emerald-500' };
            } else if (doc.llm_status === 'processing' || doc.ocr_status === 'processing') {
                return { priority: 3, status: 'Â§ÑÁêÜ‰∏≠', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'done' && hasOcrText && doc.llm_status === 'pending') {
                return { priority: 3, status: 'Â§ÑÁêÜ‰∏≠', statusClass: 'bg-blue-500' };
            } else if (doc.ocr_status === 'done' && !hasOcrText) {
                return { priority: 3, status: 'Â§ÑÁêÜ‰∏≠', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'pending') {
                return { priority: 3, status: 'Â§ÑÁêÜ‰∏≠', statusClass: 'bg-amber-500' };
            } else if (doc.ocr_status === 'failed' || doc.llm_status === 'failed') {
                return { priority: 4, status: 'ÊèêÂèñÂ§±Ë¥•', statusClass: 'bg-red-500' };
            } else {
                return { priority: 3, status: 'Â§ÑÁêÜ‰∏≠', statusClass: 'bg-amber-500' };
            }
        }

        function checkAndRetryFailed() {
            for (const doc of documents) {
                const status = getDocStatus(doc);
                const isFailed = status.status === 'ÊèêÂèñÂ§±Ë¥•';
                const isProcessing = doc.ocr_status === 'processing' || doc.llm_status === 'processing';

                if (isFailed && !isProcessing) {
                    if (doc.ocr_status === 'failed') {
                        fetch(`/api/documents/${doc.id}/retry_ocr`, { method: 'POST' }).catch(() => {});
                    } else if (doc.llm_status === 'failed') {
                        fetch(`/api/documents/${doc.id}/retry_llm`, { method: 'POST' }).catch(() => {});
                    }
                }
            }
        }

        function getActiveFilterCount() {
            let count = 0;
            if (filters.search) count++;
            if (filters.priceMin || filters.priceMax) count++;
            if (filters.areaMin || filters.areaMax) count++;
            if (filters.walking) count++;
            if (filters.propertyTypes.length > 0) count++;
            if (filters.room) count++;
            if (filters.pet) count++;
            if (filters.favorite) count++;
            return count;
        }

        function updateFilterUI() {
            const count = getActiveFilterCount();
            const badge = document.getElementById('activeFilterCount');

            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const tagsContainer = document.getElementById('activeFilterTags');
            if (count > 0) {
                tagsContainer.classList.remove('hidden');
                tagsContainer.innerHTML = '';

                if (filters.search) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700 gap-1"><i data-lucide="search" class="w-3 h-3"></i>${filters.search}<button onclick="removeFilter('search')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.priceMin || filters.priceMax) {
                    const priceText = `${filters.priceMin || '0'} - ${filters.priceMax || '‚àû'}‰∏áÂÜÜ`;
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-amber-50 rounded-full text-xs text-amber-700 gap-1"><i data-lucide="yen" class="w-3 h-3"></i>${priceText}<button onclick="removeFilter('price')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.areaMin || filters.areaMax) {
                    const areaText = `${filters.areaMin || '0'} - ${filters.areaMax || '‚àû'}m¬≤`;
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-blue-50 rounded-full text-xs text-blue-700 gap-1"><i data-lucide="maximize" class="w-3 h-3"></i>${areaText}<button onclick="removeFilter('area')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.walking) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-teal-50 rounded-full text-xs text-teal-700 gap-1"><i data-lucide="footprints" class="w-3 h-3"></i>${filters.walking}ÂàÜ‰ª•ÂÜÖ<button onclick="removeFilter('walking')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.propertyTypes.length > 0) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-purple-50 rounded-full text-xs text-purple-700 gap-1"><i data-lucide="home" class="w-3 h-3"></i>${filters.propertyTypes.join(', ')}<button onclick="removeFilter('propertyTypes')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.room) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-700 gap-1"><i data-lucide="layout" class="w-3 h-3"></i>${filters.room}<button onclick="removeFilter('room')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.pet) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-pink-50 rounded-full text-xs text-pink-700 gap-1"><i data-lucide="heart" class="w-3 h-3"></i>ÂèØÂÖªÂÆ†<button onclick="removeFilter('pet')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }
                if (filters.favorite) {
                    tagsContainer.innerHTML += `<span class="inline-flex items-center px-2 py-1 bg-rose-50 rounded-full text-xs text-rose-700 gap-1"><i data-lucide="heart" class="w-3 h-3"></i>‰ªÖÊî∂Ëóè<button onclick="removeFilter('favorite')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                }

                lucide.createIcons();
            } else {
                tagsContainer.classList.add('hidden');
            }
        }

        function removeFilter(filterName) {
            switch (filterName) {
                case 'search':
                    filters.search = '';
                    document.getElementById('searchInput').value = '';
                    break;
                case 'price':
                    filters.priceMin = null;
                    filters.priceMax = null;
                    document.getElementById('priceMin').value = '';
                    document.getElementById('priceMax').value = '';
                    break;
                case 'area':
                    filters.areaMin = null;
                    filters.areaMax = null;
                    document.getElementById('areaMin').value = '';
                    document.getElementById('areaMax').value = '';
                    break;
                case 'walking':
                    filters.walking = null;
                    document.getElementById('walkingFilter').value = '';
                    break;
                case 'propertyTypes':
                    filters.propertyTypes = [];
                    document.querySelectorAll('.property-type-filter').forEach(cb => cb.checked = false);
                    break;
                case 'room':
                    filters.room = null;
                    document.getElementById('roomFilter').value = '';
                    break;
                case 'pet':
                    filters.pet = false;
                    document.getElementById('petFilter').checked = false;
                    break;
                case 'favorite':
                    filters.favorite = false;
                    document.getElementById('favoriteFilter').checked = false;
                    break;
            }
            updateFilterUI();
            applyFilters();
        }

        function resetFilters() {
            filters = {
                search: '',
                priceMin: null,
                priceMax: null,
                areaMin: null,
                areaMax: null,
                walking: null,
                propertyTypes: [],
                room: null,
                pet: false,
                favorite: false
            };

            document.getElementById('searchInput').value = '';
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.getElementById('areaMin').value = '';
            document.getElementById('areaMax').value = '';
            document.getElementById('walkingFilter').value = '';
            document.getElementById('roomFilter').value = '';
            document.querySelectorAll('.property-type-filter').forEach(cb => cb.checked = false);
            document.getElementById('petFilter').checked = false;
            document.getElementById('favoriteFilter').checked = false;

            updateFilterUI();
            applyFilters();
        }

        function applyFilters() {
            filters.priceMin = document.getElementById('priceMin').value ? parseInt(document.getElementById('priceMin').value) : null;
            filters.priceMax = document.getElementById('priceMax').value ? parseInt(document.getElementById('priceMax').value) : null;
            filters.areaMin = document.getElementById('areaMin').value ? parseFloat(document.getElementById('areaMin').value) : null;
            filters.areaMax = document.getElementById('areaMax').value ? parseFloat(document.getElementById('areaMax').value) : null;
            filters.walking = document.getElementById('walkingFilter').value ? parseInt(document.getElementById('walkingFilter').value) : null;
            filters.room = document.getElementById('roomFilter').value || null;
            filters.pet = document.getElementById('petFilter').checked;
            filters.favorite = document.getElementById('favoriteFilter').checked;

            filters.propertyTypes = [];
            document.querySelectorAll('.property-type-filter:checked').forEach(cb => {
                filters.propertyTypes.push(cb.value);
            });

            updateFilterUI();
            renderDocuments();
        }

        function renderDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';

            filteredDocuments = documents.filter(doc => {
                const props = doc.properties || {};

                const matchSearch = !filters.search ||
                    (props.property_name || '').toLowerCase().includes(filters.search) ||
                    (props.address || '').toLowerCase().includes(filters.search);

                const matchPrice = (!filters.priceMin || !props.price || props.price >= filters.priceMin) &&
                    (!filters.priceMax || !props.price || props.price <= filters.priceMax);

                const matchArea = (!filters.areaMin || !props.exclusive_area || parseFloat(props.exclusive_area) >= filters.areaMin) &&
                    (!filters.areaMax || !props.exclusive_area || parseFloat(props.exclusive_area) <= filters.areaMax);

                const matchWalking = !filters.walking || !props.walking_minutes || parseInt(props.walking_minutes) <= filters.walking;

                const matchType = filters.propertyTypes.length === 0 ||
                    (props.property_type && filters.propertyTypes.includes(props.property_type));

                const matchRoom = !filters.room || !props.room_layout || props.room_layout === filters.room;

                const matchPet = !filters.pet || (props.pet_policy && props.pet_policy.includes('ÂèØ'));

                const matchFavorite = !filters.favorite || doc.favorite === 1;

                return matchSearch && matchPrice && matchArea && matchWalking && matchType && matchRoom && matchPet && matchFavorite;
            });

            const sorted = filteredDocuments.sort((a, b) => {
                if (b.favorite !== a.favorite) return b.favorite - a.favorite;
                const statusA = getDocStatus(a);
                const statusB = getDocStatus(b);
                return statusA.priority - statusB.priority;
            });

            const totalDocs = documents.length;
            const filteredDocs = filteredDocuments.length;
            document.getElementById('resultCount').textContent = `ÂÖ± ${totalDocs} ‰∏™Êàø‰∫ß`;

            const filteredInfo = document.getElementById('filteredCount');
            if (filteredDocs < totalDocs) {
                filteredInfo.textContent = `ÊòæÁ§∫ ${filteredDocs} ‰∏™ÁªìÊûú`;
                filteredInfo.classList.remove('hidden');
            } else {
                filteredInfo.classList.add('hidden');
            }

            const totalPages = Math.ceil(sorted.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageDocs = sorted.slice(startIndex, endIndex);

            pageDocs.forEach(doc => {
                const props = doc.properties || {};
                const status = getDocStatus(doc);
                const hasAddress = props.address && props.address.trim() !== '';
                const hasPrice = props.price && props.price !== null && props.price !== '';

                const addressHtml = hasAddress
                    ? `<span class="text-gray-600">${props.address}</span>`
                    : '<div class="animate-pulse bg-gray-200 rounded h-3 w-full"></div>';

                const stationDurations = doc.station_durations || [];
                const locationMap = new Map();
                stationDurations.forEach(sd => {
                    if (sd.show_in_tag === 1) {
                        const key = sd.location_name;
                        if (!locationMap.has(key) || sd.duration < locationMap.get(key).duration) {
                            locationMap.set(key, sd);
                        }
                    }
                });
                const locationTags = Array.from(locationMap.values())
                    .map(sd => `<span class="inline-flex items-center px-2 py-0.5 bg-purple-50 rounded text-xs text-purple-600">${sd.location_name} ${sd.duration}ÂàÜ</span>`)
                    .join('');

                const card = document.createElement('div');
                card.className = `group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer relative overflow-hidden border border-gray-100 hover:border-blue-300 h-full flex flex-col ${doc.favorite === 1 ? 'ring-2 ring-rose-400' : ''}`;
                card.onclick = (e) => {
                    if (!e.target.closest('.action-btn')) {
                        openModal(doc);
                    }
                };

                const isFavorite = doc.favorite === 1;

                card.innerHTML = `
                    <div class="p-5 pb-3 flex flex-col h-full relative">
                        <div class="flex items-start justify-between gap-2 mb-3">
                            <h3 class="font-semibold text-gray-900 leading-snug flex-1 pr-8">${props.property_name || doc.filename}</h3>
                            <div class="flex gap-1.5 flex-shrink-0">
                                <button onclick="toggleFavorite(event, ${doc.id}, ${isFavorite})" class="action-btn w-8 h-8 rounded-full flex items-center justify-center transition-all ${isFavorite ? 'bg-rose-500 text-white shadow-md shadow-rose-300' : 'bg-gray-100 text-gray-400 hover:bg-rose-500 hover:text-white'}">
                                    <i data-lucide="heart" class="w-4 h-4 ${isFavorite ? 'fill-white' : ''}"></i>
                                </button>
                                <button onclick="deleteCard(event, ${doc.id})" class="action-btn w-8 h-8 rounded-full flex items-center justify-center bg-gray-100 text-gray-400 hover:bg-red-500 hover:text-white transition-all">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-end justify-between mb-3">
                            <div>
                                ${hasPrice ? `<span class="text-3xl font-bold text-gray-900">${props.price}</span><span class="text-gray-500 ml-1">‰∏áÂÜÜ</span>` : '<div class="animate-pulse bg-gray-200 rounded h-9 w-24"></div>'}
                            </div>
                            <div class="flex items-center gap-1.5">
                                ${props.exclusive_area ? `<span class="px-2.5 py-1 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">${props.exclusive_area}m¬≤</span>` : ''}
                                ${props.balcony_area ? `<span class="px-2.5 py-1 bg-teal-50 text-teal-700 rounded-lg text-sm font-medium">Èò≥Âè∞${props.balcony_area}m¬≤</span>` : ''}
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            ${props.room_layout ? `<span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-xs font-medium">${props.room_layout}</span>` : ''}
                            ${props.land_rights ? `<span class="px-2 py-0.5 bg-orange-50 text-orange-600 rounded text-xs">${props.land_rights}</span>` : ''}
                            ${props.build_year ? `<span class="px-2 py-0.5 bg-amber-50 text-amber-600 rounded text-xs">${new Date().getFullYear() - props.build_year}Âπ¥</span>` : ''}
                            ${props.pet_policy && props.pet_policy.includes('ÂèØ') ? `<span class="px-2 py-0.5 bg-pink-50 text-pink-600 rounded text-xs">ÂèØÂÖªÂÆ†</span>` : ''}
                            ${props.corner_room ? `<span class="px-2 py-0.5 bg-violet-50 text-violet-600 rounded text-xs">ËßíÈÉ®Â±ã</span>` : ''}
                        </div>

                        <div class="space-y-2 mb-3">
                            <div class="flex items-start gap-2 text-sm">
                                <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5"></i>
                                <span class="text-gray-600 leading-relaxed">${addressHtml}</span>
                            </div>
                            ${(props.stations && Array.isArray(props.stations) && props.stations.length > 0) ? `
                                <div class="flex items-start gap-2 text-sm">
                                    <i data-lucide="train" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>
                                    <div class="flex flex-wrap gap-1.5">
                                        ${props.stations.map(s => `
                                            <span class="inline-flex items-center px-2 py-0.5 bg-emerald-50 text-emerald-700 rounded text-xs">
                                                ${s.name} <i data-lucide="footprints" class="w-3 h-3 mx-0.5 text-emerald-500"></i>${s.walking_minutes}ÂàÜ
                                            </span>
                                        `).join('')}
                                        ${locationTags}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mt-auto pt-3 border-t border-gray-100 -mx-5 px-5">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium text-white ${status.statusClass}">${status.status}</span>
                                ${doc.extracted_model ? `<span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded text-xs" title="${doc.extracted_model}">${doc.extracted_model.split('/').pop().split(':')[0]}</span>` : ''}
                            </div>
                            <span class="text-xs text-gray-400 ml-auto">${new Date(doc.upload_time).toLocaleDateString('zh-CN')}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            lucide.createIcons();
            updateFilterUI();
            renderPagination(totalPages, sorted.length, startIndex + 1, endIndex);
        }

        function renderPagination(totalPages, totalItems, startItem, endItem) {
            let pagination = document.getElementById('pagination');
            if (!pagination) {
                pagination = document.createElement('div');
                pagination.id = 'pagination';
                pagination.className = 'mt-6 flex items-center justify-center gap-2';
                document.getElementById('documentsList').parentNode.appendChild(pagination);
            }

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            html += `<span class="px-3 py-1.5 text-sm text-gray-500">${startItem}-${Math.min(endItem, totalItems)} / ${totalItems}</span>`;

            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">`;
            html += `<i data-lucide="chevron-left" class="w-4 h-4"></i>`;
            html += `</button>`;

            const pageNumbers = getPageNumbers(currentPage, totalPages);
            pageNumbers.forEach(page => {
                if (page === '...') {
                    html += `<span class="px-2 text-gray-400">...</span>`;
                } else {
                    const isActive = page === currentPage;
                    html += `<button onclick="goToPage(${page})" class="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-medium transition ${isActive ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-100'}">${page}</button>`;
                }
            });

            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition">`;
            html += `<i data-lucide="chevron-right" class="w-4 h-4"></i>`;
            html += `</button>`;

            html += `<input type="number" min="1" max="${totalPages}" onkeydown="if(event.key==='Enter'){goToPage(this.value)}" placeholder="È°µ" class="w-14 px-2 py-1.5 text-sm border border-gray-200 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">`;

            pagination.innerHTML = html;
            lucide.createIcons();
        }

        function getPageNumbers(current, total) {
            if (total <= 7) {
                return Array.from({length: total}, (_, i) => i + 1);
            }

            const pages = [];
            pages.push(1);

            const leftBound = Math.max(2, current - 2);
            const rightBound = Math.min(total - 1, current + 2);

            if (leftBound > 2) pages.push('...');

            for (let i = leftBound; i <= rightBound; i++) {
                pages.push(i);
            }

            if (rightBound < total - 1) pages.push('...');

            pages.push(total);
            return pages;
        }

        function goToPage(page) {
            page = Math.max(1, Math.min(page, Math.ceil(filteredDocuments.length / ITEMS_PER_PAGE)));
            if (page !== currentPage) {
                currentPage = page;
                renderDocuments();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        async function openModal(doc) {
            currentDocId = doc.id;
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const previewContainer = document.getElementById('previewContainer');
            const ocrTextContainer = document.getElementById('ocrTextContainer');
            const form = document.getElementById('propertiesForm');

            const props = doc.properties || {};
            title.textContent = props.property_name || doc.filename;

            const previewImage = document.getElementById('previewImage');
            const previewLoading = document.getElementById('previewLoading');
            
            previewImage.classList.add('hidden');
            previewImage.classList.remove('image-fade-in');
            previewLoading.style.display = 'flex';
            previewContainer.style.minHeight = '400px';
            previewImage.src = `/api/preview/${doc.id}`;

            ocrTextContainer.textContent = doc.ocr_text || 'ÊöÇÊó†OCRÊñáÊú¨';

            const fieldOrder = [
                'address', 'price', 'property_name', 'room_layout', 'exclusive_area',
                'build_year', 'structure', 'floor_number', 'total_floors', 'orientation',
                'corner_room', 'management_fee', 'repair_fee', 'balcony_area', 'nearest_station', 'train_line', 'walking_minutes',
                'prefecture', 'city', 'land_rights', 'current_status', 'handover_date',
                'parking', 'pet_policy'
            ];

            form.innerHTML = '';
            
            // Compact grid for top fields
            const topFields = ['address', 'price', 'property_name', 'room_layout', 'exclusive_area', 'build_year', 'structure', 'floor_number', 'total_floors'];
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'grid grid-cols-2 gap-2 mb-3';
            
            for (const key of topFields) {
                if (fieldLabels[key]) {
                    const value = props[key] || '';
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    gridDiv.appendChild(div);
                }
            }
            form.appendChild(gridDiv);
            
            // Secondary fields in compact rows
            const secondaryFields = ['orientation', 'management_fee', 'repair_fee', 'balcony_area'];
            const secondaryDiv = document.createElement('div');
            secondaryDiv.className = 'grid grid-cols-3 gap-2 mb-3';
            
            for (const key of secondaryFields) {
                if (fieldLabels[key]) {
                    const value = props[key] || '';
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    secondaryDiv.appendChild(div);
                }
            }
            form.appendChild(secondaryDiv);
            
            // Other fields in compact grid
            const otherFields = ['corner_room', 'prefecture', 'city', 'land_rights', 'current_status', 'handover_date', 'parking', 'pet_policy'];
            const otherDiv = document.createElement('div');
            otherDiv.className = 'grid grid-cols-4 gap-2';
            
            for (const key of otherFields) {
                if (fieldLabels[key]) {
                    let value = props[key] || '';
                    // corner_room ÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊòØ true ÊòæÁ§∫"ËßíÈÉ®Â±ã"
                    if (key === 'corner_room' && value === true) {
                        value = 'ËßíÈÉ®Â±ã';
                    }
                    const div = document.createElement('div');
                    div.className = 'flex flex-col';
                    div.innerHTML = `
                        <label class="text-xs text-gray-500 mb-0.5">${fieldLabels[key]}</label>
                        <input type="text" name="${key}" value="${value}" 
                               class="px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    `;
                    otherDiv.appendChild(div);
                }
            }
            form.appendChild(otherDiv);

            // Stations section
            const stationsLabel = document.createElement('label');
            stationsLabel.className = 'text-xs text-gray-500 mb-1 block';
            stationsLabel.textContent = 'ÈôÑËøëËΩ¶Á´ô (ÊúÄÂ§ö3‰∏™)';
            form.appendChild(stationsLabel);

            const stationsDiv = document.createElement('div');
            stationsDiv.className = 'space-y-2 mb-2';
            stationsDiv.id = 'stationsContainer';

            const stations = props.stations && Array.isArray(props.stations) ? props.stations : [];
            for (let i = 0; i < 3; i++) {
                const station = stations[i] || { name: '', line: '', walking_minutes: '' };
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 items-center';
                row.dataset.index = i;
                row.innerHTML = `
                    <div class="col-span-4">
                        <input type="text" name="station_${i}_name" value="${station.name}" placeholder="ËΩ¶Á´ôÂêçÁß∞"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                    <div class="col-span-4">
                        <input type="text" name="station_${i}_line" value="${station.line}" placeholder="Á∫øË∑Ø"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                    <div class="col-span-3">
                        <input type="text" name="station_${i}_walking" value="${station.walking_minutes}" placeholder="ÂæíÊ≠•(ÂàÜÈíü)"
                               class="w-full px-2 py-1.5 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm">
                    </div>
                `;
                stationsDiv.appendChild(row);
            }
            form.appendChild(stationsDiv);

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function onPreviewLoaded() {
            const previewImage = document.getElementById('previewImage');
            const previewLoading = document.getElementById('previewLoading');
            const previewContainer = document.getElementById('previewContainer');
            
            const naturalHeight = previewImage.naturalHeight;
            const naturalWidth = previewImage.naturalWidth;
            const containerMaxHeight = window.innerHeight * 0.6;
            
            if (naturalWidth > 0) {
                const scaledHeight = (naturalHeight / naturalWidth) * previewImage.offsetWidth;
                const finalHeight = Math.min(scaledHeight, containerMaxHeight);
                previewContainer.style.minHeight = `${finalHeight}px`;
            }
            
            previewImage.classList.remove('hidden');
            previewImage.classList.add('image-fade-in');
            previewLoading.style.display = 'none';
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentDocId = null;
        }

        async function deleteDocument() {
            if (!currentDocId) return;

            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£Âêó?')) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}`, {
                    method: 'DELETE'
                });
                await response.json();
                closeModal();
                loadDocuments();
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        async function deleteAllUnfavorited() {
            const count = documents.filter(d => d.favorite !== 1).length;
            if (count === 0) {
                alert('Ê≤°ÊúâÈúÄË¶ÅÊ∏ÖÁêÜÁöÑÊñáÊ°£');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâ ${count} ‰∏™ÈùûÊî∂ËóèÊñáÊ°£ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) return;

            try {
                const response = await fetch('/api/documents/cleanup', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    alert(`Â∑≤Âà†Èô§ ${result.deleted_count} ‰∏™ÊñáÊ°£`);
                    loadDocuments();
                } else {
                    alert(result.error || 'Ê∏ÖÁêÜÂ§±Ë¥•');
                }
            } catch (error) {
                alert('Ê∏ÖÁêÜÂ§±Ë¥•: ' + error.message);
            }
        }

        async function toggleFavorite(event, docId, isFavorite) {
            event.stopPropagation();

            try {
                const response = await fetch(`/api/documents/${docId}/favorite`, {
                    method: 'POST'
                });
                const result = await response.json();
                await loadDocuments();
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        async function deleteCard(event, docId) {
            event.stopPropagation();

            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£Âêó?')) return;

            try {
                const response = await fetch(`/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                await response.json();
                loadDocuments();
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        async function saveProperties() {
            const form = document.getElementById('propertiesForm');
            const formData = new FormData(form);
            const properties = {};

            for (const [key, value] of formData.entries()) {
                if (key.startsWith('station_')) {
                    continue;
                }
                properties[key] = value || null;
            }

            // Handle stations
            const stations = [];
            for (let i = 0; i < 3; i++) {
                const name = formData.get(`station_${i}_name`);
                const line = formData.get(`station_${i}_line`);
                const walking = formData.get(`station_${i}_walking`);
                if (name && name.trim() !== '') {
                    stations.push({
                        name: name.trim(),
                        line: line ? line.trim() : '',
                        walking_minutes: walking ? walking.trim() : ''
                    });
                }
            }
            properties.stations = stations.length > 0 ? stations : null;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(properties)
                });
                await response.json();
                loadDocuments();
                closeModal();
            } catch (error) {
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        async function openModelModal() {
            await loadModels();
            document.getElementById('modelModal').classList.remove('hidden');
        }

        function closeModelModal() {
            document.getElementById('modelModal').classList.add('hidden');
        }

        async function loadModels() {
            try {
                const response = await fetch(`/api/models?t=${Date.now()}`);
                const data = await response.json();
                renderModels(data.models);
            } catch (error) {
                console.error('Âä†ËΩΩÊ®°ÂûãÂ§±Ë¥•:', error);
            }
        }

        function renderModels(models) {
            const container = document.getElementById('modelsList');
            if (container._sortableInstance) {
                container._sortableInstance.destroy();
            }
            container.innerHTML = '';

            if (models.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i data-lucide="database" class="w-12 h-12 text-gray-300 mb-3"></i>
                        <p class="text-gray-400">ÊöÇÊó†ÂèØÁî®Ê®°Âûã</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            models.forEach(model => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group cursor-move';
                div.dataset.model = model;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move"></i>
                        <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="cpu" class="w-4 h-4 text-blue-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium text-sm font-mono">${model}</span>
                    </div>
                    <button onclick="deleteModel('${model}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all group-hover:scale-105">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            container._sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-blue-50',
                handle: '[data-lucide="grip-vertical"]',
                onEnd: async function(evt) {
                    const newOrder = [];
                    container.querySelectorAll('[data-model]').forEach(item => {
                        newOrder.push(item.dataset.model);
                    });
                    try {
                        await fetch('/api/models/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ models: newOrder })
                        });
                    } catch (error) {
                        console.error('‰øùÂ≠òÊ®°ÂûãÈ°∫Â∫èÂ§±Ë¥•:', error);
                        await loadModels();
                    }
                }
            });
        }

        async function addModel() {
            const input = document.getElementById('newModelInput');
            const modelName = input.value.trim();

            if (!modelName) {
                alert('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
                return;
            }

            try {
                const response = await fetch('/api/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                const result = await response.json();
                if (result.success) {
                    input.value = '';
                    await loadModels();
                } else {
                    alert(result.error || 'Ê∑ªÂä†Â§±Ë¥•');
                }
            } catch (error) {
                alert('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
            }
        }

        async function deleteModel(modelName) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âûã "${modelName}" Âêó?`)) return;

            try {
                const response = await fetch('/api/models/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                const result = await response.json();
                if (result.success) {
                    await loadModels();
                } else {
                    alert(result.error || 'Âà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        let viewerScale = 1;
        let viewerRotation = 0;
        let viewerTranslateX = 0;
        let viewerTranslateY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let viewerImage = null;
        let viewerContainer = null;

        function openImageViewer(event) {
            if (!currentDocId) return;

            const modal = document.getElementById('imageViewerModal');
            const image = document.getElementById('viewerImage');
            const title = document.getElementById('viewerTitle');
            const loading = document.getElementById('viewerLoading');

            viewerImage = image;
            viewerContainer = document.getElementById('imageViewerContainer');

            const doc = documents.find(d => d.id === currentDocId);
            title.textContent = doc?.filename || 'ÊñáÊ°£È¢ÑËßà';

            modal.classList.remove('hidden');
            modal.classList.remove('closing');
            loading.classList.remove('hidden');
            image.style.display = 'none';

            image.src = `/api/preview/${currentDocId}`;
            image.onload = () => {
                loading.classList.add('hidden');
                image.style.display = 'block';
                fitToScreen();
            };
            image.onerror = () => {
                loading.classList.add('hidden');
                title.textContent = 'È¢ÑËßàÂä†ËΩΩÂ§±Ë¥•';
            };
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.classList.add('closing');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                resetViewerState();
            }, 200);
        }

        function resetViewerState() {
            viewerScale = 1;
            viewerRotation = 0;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            if (!viewerImage) return;
            viewerImage.style.transform = `
                translate(calc(-50% + ${viewerTranslateX}px), calc(-50% + ${viewerTranslateY}px))
                rotate(${viewerRotation}deg)
                scale(${viewerScale})
            `;
            document.getElementById('zoomLevel').textContent = Math.round(viewerScale * 100) + '%';
        }

        function zoomIn() {
            viewerScale = Math.min(viewerScale * 1.2, 5);
            updateImageTransform();
        }

        function zoomOut() {
            viewerScale = Math.max(viewerScale / 1.2, 0.1);
            updateImageTransform();
        }

        function resetZoom() {
            viewerScale = 1;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function fitToScreen() {
            if (!viewerImage || !viewerContainer) return;

            const containerWidth = viewerContainer.clientWidth - 80;
            const containerHeight = viewerContainer.clientHeight - 100;

            const imgRatio = viewerImage.naturalWidth / viewerImage.naturalHeight;
            const containerRatio = containerWidth / containerHeight;

            let targetWidth, targetHeight;

            if (imgRatio > containerRatio) {
                targetWidth = Math.min(containerWidth, viewerImage.naturalWidth);
                targetHeight = targetWidth / imgRatio;
            } else {
                targetHeight = Math.min(containerHeight, viewerImage.naturalHeight);
                targetWidth = targetHeight * imgRatio;
            }

            viewerImage.style.width = targetWidth + 'px';
            viewerImage.style.height = targetHeight + 'px';
            viewerImage.style.position = 'absolute';
            viewerImage.style.left = '50%';
            viewerImage.style.top = '50%';
            viewerImage.style.transform = 'translate(-50%, -50%)';

            viewerScale = targetWidth / viewerImage.naturalWidth;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
        }

        function actualSize() {
            viewerScale = 1;
            viewerTranslateX = 0;
            viewerTranslateY = 0;
            updateImageTransform();
        }

        function rotateLeft() {
            viewerRotation = (viewerRotation - 90) % 360;
            updateImageTransform();
        }

        function rotateRight() {
            viewerRotation = (viewerRotation + 90) % 360;
            updateImageTransform();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('imageViewerContainer');
            const image = document.getElementById('viewerImage');

            if (container) {
                container.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        if (e.deltaY < 0) {
                            zoomIn();
                        } else {
                            zoomOut();
                        }
                    }
                });

                container.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        isDragging = true;
                        dragStartX = e.clientX - viewerTranslateX;
                        dragStartY = e.clientY - viewerTranslateY;
                        image?.style.setProperty('cursor', 'grabbing');
                    }
                });
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                viewerTranslateX = e.clientX - dragStartX;
                viewerTranslateY = e.clientY - dragStartY;
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                viewerImage?.style.setProperty('cursor', 'grab');
            }
        });

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('imageViewerModal');
            if (modal.classList.contains('hidden')) return;

            if (e.key === 'Escape') {
                closeImageViewer();
            } else if (e.key === '+' || e.key === '=') {
                zoomIn();
            } else if (e.key === '-' || e.key === '_') {
                zoomOut();
            } else if (e.key === 'r' || e.key === 'R') {
                rotateRight();
            } else if (e.key === 'e' || e.key === 'E') {
                rotateLeft();
            } else if (e.key === '0') {
                fitToScreen();
            } else if (e.key === '1') {
                actualSize();
            }
        });

        async function retryLLM() {
            if (!currentDocId) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/retry_llm`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    closeModal();
                    loadDocuments();
                } else {
                    alert('ÈáçËØïÂ§±Ë¥•');
                }
            } catch (error) {
                alert('ÈáçËØïÂ§±Ë¥•: ' + error.message);
            }
        }

        async function retryOCR() {
            if (!currentDocId) return;

            try {
                const response = await fetch(`/api/documents/${currentDocId}/retry_ocr`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    closeModal();
                    loadDocuments();
                } else {
                    alert('ÈáçËØïÂ§±Ë¥•');
                }
            } catch (error) {
                alert('ÈáçËØïÂ§±Ë¥•: ' + error.message);
            }
        }

        async function openLocationModal() {
            await loadLocations();
            document.getElementById('locationModal').classList.remove('hidden');
        }

        function closeLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const data = await response.json();
                locations = data.locations;
                renderLocations();
            } catch (error) {
                console.error('Âä†ËΩΩ‰ΩçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        function renderLocations() {
            const container = document.getElementById('locationsList');
            if (container._sortableInstance) {
                container._sortableInstance.destroy();
            }
            container.innerHTML = '';

            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i data-lucide="map" class="w-12 h-12 text-gray-300 mb-3"></i>
                        <p class="text-gray-400">ÊöÇÊó†‰ΩçÁΩÆ</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            locations.forEach(loc => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:border-blue-300 transition-all group cursor-move';
                div.dataset.location = loc.id;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move"></i>
                        <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                            <i data-lucide="map-pin" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <span class="text-gray-700 font-medium text-sm">${loc.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="inline-flex items-center px-3 py-1 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-300">
                            <input type="checkbox" class="location-display-filter hidden" ${loc.show_in_tag ? 'checked' : ''} onchange="updateLocationDisplay(${loc.id}, this.checked)">
                            <span class="text-xs text-gray-600">ÊòæÁ§∫tag</span>
                        </label>
                        <button onclick="deleteLocation(${loc.id})" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all group-hover:scale-105">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            container._sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'bg-blue-50',
                handle: '[data-lucide="grip-vertical"]',
                onEnd: async function(evt) {
                    const newOrder = [];
                    container.querySelectorAll('[data-location]').forEach(item => {
                        newOrder.push(parseInt(item.dataset.location));
                    });
                    try {
                        await fetch('/api/locations/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ location_ids: newOrder })
                        });
                        await loadLocations();
                    } catch (error) {
                        console.error('‰øùÂ≠ò‰ΩçÁΩÆÈ°∫Â∫èÂ§±Ë¥•:', error);
                    }
                }
            });
        }

        async function addLocation() {
            const input = document.getElementById('newLocationInput');
            const name = input.value.trim();

            if (!name) {
                alert('ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞');
                return;
            }

            try {
                const response = await fetch('/api/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();
                if (result.success) {
                    input.value = '';
                    await loadLocations();
                } else {
                    alert('Ê∑ªÂä†Â§±Ë¥•');
                }
            } catch (error) {
                alert('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
            }
        }

        async function deleteLocation(locationId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ΩçÁΩÆÂêóÔºüËøôÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑËΩ¶Á´ôÊó∂ÈïøÊï∞ÊçÆ„ÄÇ')) return;

            try {
                const response = await fetch(`/api/locations/${locationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    await loadLocations();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        async function updateLocationDisplay(locationId, showInTag) {
            try {
                const response = await fetch(`/api/locations/${locationId}/display`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ show_in_tag: showInTag ? 1 : 0 })
                });

                const result = await response.json();
                if (result.success) {
                    await loadLocations();
                    await loadDocuments();
                } else {
                    alert('Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                alert('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        async function openStationModal() {
            await loadLocations();
            await loadStationDurations();
            document.getElementById('stationModal').classList.remove('hidden');
        }

        function closeStationModal() {
            document.getElementById('stationModal').classList.add('hidden');
        }

        async function loadStationDurations() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const table = document.getElementById('stationDurationTable');
            const searchInput = document.getElementById('stationSearchInput');

            tableBody.innerHTML = '';
            allStationRows = [];
            tableHeader.innerHTML = '<th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[150px] sticky left-0 bg-gray-50 z-20">ËΩ¶Á´ô</th>';

            const stationNames = new Set();
            documents.forEach(doc => {
                const props = doc.properties || {};
                if (props.stations && Array.isArray(props.stations)) {
                    props.stations.forEach(s => {
                        if (s.name && s.name.trim()) {
                            stationNames.add(s.name.trim());
                        }
                    });
                }
            });

            const sortedStations = Array.from(stationNames).sort();

            if (sortedStations.length === 0 || locations.length === 0) {
                table.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            locations.forEach(loc => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-gray-200 min-w-[120px]';
                th.textContent = loc.name;
                tableHeader.appendChild(th);
            });

            let durationsMap = {};
            try {
                const response = await fetch('/api/station_durations');
                const data = await response.json();
                data.durations.forEach(d => {
                    const key = `${d.station_name}_${d.location_id}`;
                    durationsMap[key] = d.duration;
                });
            } catch (error) {
                console.error('Âä†ËΩΩËΩ¶Á´ôÊó∂ÈïøÂ§±Ë¥•:', error);
            }

            sortedStations.forEach(stationName => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.dataset.stationName = stationName.toLowerCase();

                const nameTd = document.createElement('td');
                nameTd.className = 'px-4 py-3 text-sm text-gray-900 border-b border-gray-200 font-medium sticky left-0 bg-white hover:bg-gray-50 z-20';
                nameTd.innerHTML = `<i data-lucide="train" class="w-4 h-4 inline mr-2 text-gray-400"></i>${stationName}`;
                tr.appendChild(nameTd);

                locations.forEach(loc => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 border-b border-gray-200 text-center';
                    const key = `${stationName}_${loc.id}`;
                    const value = durationsMap[key] || '';
                    td.innerHTML = `
                        <input type="number"
                               class="w-24 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm text-center"
                               data-station="${stationName}"
                               data-location-id="${loc.id}"
                               value="${value}"
                               min="0"
                               placeholder="-">
                    `;
                    tr.appendChild(td);
                });

                allStationRows.push(tr);
                tableBody.appendChild(tr);
            });

            lucide.createIcons();

            filterStations(searchInput.value);
        }

        function filterStations(searchTerm) {
            const lowerTerm = searchTerm.toLowerCase();

            allStationRows.forEach(row => {
                const stationName = row.dataset.stationName || '';
                if (stationName.includes(lowerTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function saveStationDurations() {
            const inputs = document.querySelectorAll('#tableBody input[type="number"]');
            const durations = [];

            inputs.forEach(input => {
                const stationName = input.dataset.station;
                const locationId = parseInt(input.dataset.locationId);
                const duration = input.value ? parseInt(input.value) : null;
                durations.push({ station_name: stationName, location_id: locationId, duration });
            });

            try {
                const response = await fetch('/api/station_durations/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ durations })
                });
                const result = await response.json();
                if (result.success) {
                    loadDocuments();
                    closeStationModal();
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + result.error);
                }
            } catch (error) {
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        loadLocations();
        loadDocuments();
        setInterval(loadDocuments, 5000);
        lucide.createIcons();
    </script>
</body>
</html>
