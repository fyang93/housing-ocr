# 更新历史

## 2026-01-11 - 修复vLLM CUDA错误

### 问题

vLLM服务器在处理队列请求时遇到CUDA错误并崩溃：
```
torch.cuda.AcceleratorError: CUDA error: device-side assert triggered
```

### 根本原因

1. GPU内存利用率设置过高（0.95），接近满载
2. 并发请求数量过多（2个OCR Workers + 2个LLM Workers）
3. GPU在处理多个并发请求时触发CUDA断言失败

### 解决方案

1. 降低GPU内存利用率
   - 从 0.95 降至 0.85
   - 减少GPU压力

2. 减少并发数
   - OCR Workers: 2个 → 1个
   - LLM Workers: 2个 → 1个
   - 避免并发GPU访问

### 修改文件

- justfile - GPU内存利用率 0.95 → 0.85
- src/housing_ocr/queue_manager.py - Workers各从2个减少到1个

### 效果

- 减少GPU内存压力
- 避免并发CUDA错误
- vLLM服务器更稳定

---

## 2026-01-11 - 后台任务队列系统

### 系统架构

分层队列设计：
- 新文档上传 → OCR队列(优先级5) → OCR Workers(2) → LLM队列 → LLM Workers(2) → 完成

### 核心功能

1. 后台自动排队处理（OCR + LLM）
   - OCR和LLM分别使用独立队列
   - 2个OCR Worker并发处理
   - 2个LLM Worker并发处理
   - OCR完成后自动触发LLM提取

2. 自动重试机制（最多3次）
   - 失败自动重试，每次间隔30秒
   - 超过次数后停止

3. 手动介入按钮
   - 重试OCR（绿色） - 高优先级重新处理
   - 重新提取（蓝色） - 高优先级重新LLM
   - 保存修改（紫色） - 保存手动编辑

4. LLM结果手动编辑调整
   - 所有29个字段可编辑
   - 编辑/取消编辑切换
   - 即时保存

### 优先级系统

- 优先级1(最高)：手动触发 - 立即处理
- 优先级3：自动重试 - 30秒后处理
- 优先级5(默认)：新文档 - 正常队列

### 状态管理

OCR状态：
- pending(黄色) - 等待处理
- processing(蓝色) - 处理中
- completed(绿色) - 完成
- failed(红色) - 失败

LLM状态：
- pending - 等待OCR完成
- processing - 处理中
- completed - 完成
- failed - 失败
- manual_edit(紫色) - 手动编辑中

### 实时状态更新

- 处理中状态每3秒刷新
- 自动更新OCR文本和房产信息
- 处理完成后停止轮询

### 文件变更

新增：
- src/housing_ocr/queue_manager.py - 队列管理器
- scripts/migrate_queue_fields.py - 数据库迁移

修改：
- src/housing_ocr/database.py - 添加状态字段
- src/housing_ocr/app.py - 集成队列管理器
- src/housing_ocr/templates/index.html - 前端界面

### 数据库字段

OCR相关：
- ocr_status: OCR状态
- ocr_priority: 优先级(1-10)
- ocr_error_message: 错误信息
- ocr_last_attempt: 最后尝试时间

LLM相关：
- llm_status: LLM状态
- llm_priority: 优先级(1-10)
- llm_error_message: 错误信息
- llm_last_attempt: 最后尝试时间

### API接口

- POST /upload - 上传文件，自动加入OCR队列
- POST /api/reocr/<id> - 重试OCR（高优先级）
- POST /api/retry_llm/<id> - 重新提取LLM（高优先级）
- POST /api/update_property/<id> - 更新房产信息（手动编辑）

---

## 2026-01-11 - OpenRouter API 集成

### 更新内容

1. 配置文件
   - 新增 config.toml 文件用于配置 OpenRouter API Key
   - 支持 4 个免费 LLM 模型：
     - google/gemini-2.0-flash-exp:free (默认)
     - moonshotai/kimi-k2:free
     - deepseek/deepseek-r1-0528:free
     - qwen/qwen3-4b:free

2. Python 依赖
   - 新增 tomli 用于读取 TOML 配置文件

3. OCR 处理 (ocr.py)
   - OCR 继续使用本地 vLLM 服务 (dots.ocr 模型)
   - LLM 抽取改为使用 OpenRouter API
   - 如果未配置 API Key，会跳过房产信息抽取（OCR 仍正常工作）

4. Web 应用 (app.py)
   - 更新 /api/models 路由返回 OpenRouter 模型列表
   - 上传时自动使用选择的模型进行 LLM 抽取

5. 前端 (index.html)
   - 模型选择下拉菜单现在动态加载 OpenRouter 模型
   - 默认选中 Gemini 2.0 Flash

### 配置步骤

1. 获取 API Key
   - 访问 https://openrouter.ai/ 注册并获取免费 API Key

2. 编辑配置文件
   - 编辑 config.toml 添加 API Key

3. 重启应用
   - just run

### 注意事项

- vLLM 服务器 (just server) 仍需运行，用于 OCR 处理
- 如果没有配置 OpenRouter API Key，系统会跳过 LLM 抽取步骤
- 所有 LLM 模型均为免费版，使用 OpenRouter 免费额度

---

## 2026-01-11 - 重新OCR功能

### 功能说明

在房产详情页面添加了"重新OCR"按钮，允许用户手动重新处理文档的OCR和房产信息抽取。

### 实现细节

1. 前端修改 (index.html)
   - 添加"重新OCR"按钮到模态窗口标题栏
   - 添加 currentDocId 变量跟踪当前文档
   - 实现 reOCR() JavaScript 函数
   - 按钮状态管理（禁用/启用）

2. 后端修改 (app.py)
   - 新增 /api/reocr/<id> POST 路由
   - 重新调用 process_document() 进行OCR
   - 重新调用 extract_property_info() 抽取房产信息
   - 更新数据库记录

### 使用流程

1. 用户点击房产卡片，打开详情模态窗口
2. 查看OCR文本和房产信息
3. 如果需要重新处理，点击"重新OCR"按钮
4. 按钮显示"处理中..."，禁用状态
5. 后端重新处理文档（OCR + LLM抽取）
6. 处理完成后：
   - 显示成功提示
   - 自动刷新详情页面
   - 刷新房产列表

### 功能特点

- 用户友好的界面交互
- 完整的错误处理
- 自动刷新详情和列表
- 防止重复处理（禁用状态）

---

## 2026-01-11 - OCR 自动重试修复

### 问题描述

之前的OCR处理会立即失败，错误信息：
```
OCR API error: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/chat/completions
```

### 解决方案

1. 添加自动重试机制 (src/housing_ocr/ocr.py)
   - MAX_RETRIES = 3
   - RETRY_DELAY = 5  # 秒
   - VLLM_API_TIMEOUT = 300  # 秒

2. 更新了 process_image() 函数
   - 添加自动重试逻辑（最多3次）
   - 连接失败时等待5秒后重试
   - 超时时也会重试
   - 改进错误信息，提供更明确的提示

3. 新增测试脚本
   - scripts/test_vllm_connection.py - 测试vLLM连接
   - scripts/test_ocr.py - 测试OCR处理

### 重试行为

| 情况 | 行为 | 最大等待时间 |
|------|------|-------------|
| 连接失败 | 5秒后重试，最多3次 | 10秒 |
| 超时 | 5秒后重试，最多3次 | 10秒 |
| 其他错误 | 立即返回错误 | 0秒 |

### 错误信息改进

现在会返回更清晰的错误信息：
- `无法连接到vLLM服务器，请确认'just server'已启动`
- `请求超时`
- `OCR API错误: [具体错误]`

---

## 2026-01-11 - OpenRouter API 集成更新说明

### 更新内容

1. 配置文件
   - 新增 config.toml 文件用于配置 OpenRouter API Key
   - 支持 4 个免费 LLM 模型

2. Python 依赖
   - 新增 tomli 用于读取 TOML 配置文件

3. OCR 处理 (ocr.py)
   - OCR 继续使用本地 vLLM 服务 (dots.ocr 模型)
   - LLM 抽取改为使用 OpenRouter API
   - 如果未配置 API Key，会跳过房产信息抽取

4. Web 应用 (app.py)
   - 更新 /api/models 路由返回 OpenRouter 模型列表
   - 上传时自动使用选择的模型进行 LLM 抽取

5. 前端 (index.html)
   - 模型选择下拉菜单现在动态加载 OpenRouter 模型
   - 默认选中 Gemini 2.0 Flash

### 可用模型

- **google/gemini-2.0-flash-exp:free** (默认) - Gemini 2.0 Flash
- **moonshotai/kimi-k2:free** - Kimi K2
- **deepseek/deepseek-r1-0528:free** - DeepSeek R1
- **qwen/qwen3-4b:free** - Qwen 3 4B

### 注意事项

- vLLM 服务器 (`just server`) 仍需运行，用于 OCR 处理
- 如果没有配置 OpenRouter API Key，系统会跳过 LLM 抽取步骤
- 所有 LLM 模型均为免费版，使用 OpenRouter 免费额度

---

## 2026-01-10 - 数据库更新和UI优化

### 数据库更新

添加了房产信息字段和LLM模型字段：
- 房产类型、名称、房间号
- 地址（都道府県、区市町村、町名）
- 现状、引渡日期、装修信息
- 建成年份、构造、楼层信息
- 房间布局、朝向
- 价格、管理费、修缮基金
- 各类面积（专有、土地、建筑、阳台）
- 交通信息（最近车站、线路、徒步时间）
- 停车场、购物、宠物政策等（共29个字段）

### 前端重构

1. 固定顶部导航栏
   - LLM模型下拉菜单
   - 上传文件按钮（点击上传后弹出上传文件对话框）

2. 房产筛选组件
   - 房产类型、都道府県、区市町村、价格范围

3. 房产卡片展示
   - 显示房产名称、地址、价格等信息

4. 模态窗口
   - 点击房产卡片后显示
   - 原始文档（PDF渲染或者图像）
   - OCR文本
   - LLM抽取的信息

### OCR/LLM处理增强

1. 添加 LLM 抽取功能
2. 添加日本单位转换函数（畳→1.62m², 坪→3.3m²）

### 后端路由更新

- 添加模型切换API
- 添加房产列表/筛选API
- 添加房产详情API

### PDF.js集成

用于PDF预览

---

## 2026-01-10 - 初始版本

### 功能

- 上传 PDF、JPG、PNG 文件进行 OCR 识别
- 使用 dots.ocr 模型进行高精度文本提取
- 文件存储使用哈希命名
- SQLite 数据库文档跟踪
- 查看识别文本和文档预览